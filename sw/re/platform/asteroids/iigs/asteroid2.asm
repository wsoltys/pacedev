

;
; +-------------------------------------------------------------------------+
; |   This file has been generated by The Interactive Disassembler (IDA)    |
; |           Copyright (c) 2015 Hex-Rays, <support@hex-rays.com>           |
; |                      License info: 48-B437-7294-77                      |
; |                        Chris Nott, Virtual Logic                        |
; +-------------------------------------------------------------------------+
;
; Input SHA256 : 459D5B10D9E90B9F88198CE9273E94B902CDC20EBF089EE69E2B93951888F569
; Input MD5    : E6C34B639FE16DEFF0F951BE63076812
; Input CRC32  : 8B71FD9E

;
; +-------------------------------------------------+
; + Asteroids (Rev 2) Disassembly v0.01             +
; +   - by tcdev (msmcdoug@gmail.com)               +
; +   - based on work by Lonnie Howell              +
; +-------------------------------------------------+
;
; File Name   : E:\dev\pace\pacedev.net\sw\re\platform\asteroids\roms\asteroid2.bin
; Format      : Binary file
; Base Address: 0000h Range: 6800h - 8000h Loaded length: 00001800h
;
; Uncomment for CA65 using apple2enh-asm.cfg
;
.import __MAIN_START__, __MAIN_LAST__, __BSS_LOAD__ ;  Linker generated
.segment "EXEHDR"
.addr __MAIN_START__ ;  Start address
;.word __BSS_LOAD__ - __MAIN_START__ ; Size
.word __MAIN_LAST__ + 1 - __MAIN_START__ ; Size

 .include "apple2.inc"

.export START
.export display_hs_entry

.ZEROPAGE

; ; Processor:        M6502
; ; Target assembler: SVENSON ELECTRONICS 6502/65C02 ASSEMBLER - V.1.0 - MAY, 1988

; ===========================================================================

; Segment type: Regular
                                ;.segment ZEROPAGE
globalScale:                    .BYTE 0 ; (uninited)
byte_1:                         .BYTE 0 ; (uninited)
dvg_curr_addr_lsb:              .BYTE 0 ; (uninited)
dvg_curr_addr_msb:              .BYTE 0 ; (uninited)
byte_4:                         .BYTE 0 ; (uninited)                            ; tmp store coord conversion
byte_5:                         .BYTE 0 ; (uninited)                            ; tmp store coord conversion
byte_6:                         .BYTE 0 ; (uninited)                            ; tmp store coord conversion
byte_7:                         .BYTE 0 ; (uninited)                            ; tmp store coord conversion
byte_8:                         .BYTE 0 ; (uninited)                            ; tmp store
byte_9:                         .BYTE 0 ; (uninited)                            ; tmp store
byte_A:                         .BYTE 0 ; (uninited)
byte_B:                         .BYTE 0 ; (uninited)
byte_C:                         .BYTE 0 ; (uninited)
byte_D:                         .BYTE 0 ; (uninited)
byte_E:                         .BYTE 0 ; (uninited)
byte_F:                         .BYTE 0 ; (uninited)
initial_offset:                 .BYTE 0 ; (uninited)
                                .BYTE 0 ; (uninited)
                                .BYTE 0 ; (uninited)
                                .BYTE 0 ; (uninited)
                                .BYTE 0 ; (uninited)
byte_15:                        .BYTE 0 ; (uninited)
byte_16:                        .BYTE 0 ; (uninited)
extra_brightness:               .BYTE 0 ; (uninited)
curPlayer:                      .BYTE 0 ; (uninited)
curPlayer_x2:                   .BYTE 0 ; (uninited)
numPlayersPreviousGame:         .BYTE 0 ; (uninited)
byte_1B:                        .BYTE 0 ; (uninited)
numPlayers:                     .BYTE 0 ; (uninited)

; High score format (2 bytes)
; byte 1 - tens (in decimal)
; byte 2 - thousands (in decimal)
highScoreTable:                 .BYTE 0,0 ; (uninited)
                                .BYTE 0,0 ; (uninited)
                                .BYTE 0,0 ; (uninited)
                                .BYTE 0,0 ; (uninited)
                                .BYTE 0,0 ; (uninited)
                                .BYTE 0,0 ; (uninited)
                                .BYTE 0,0 ; (uninited)
                                .BYTE 0,0 ; (uninited)
                                .BYTE 0,0 ; (uninited)
                                .BYTE 0,0 ; (uninited)
letterHighScoreEntry:           .BYTE 0 ; (uninited)
placeP1HighScore:               .BYTE 0 ; (uninited)
placeP2HighScore:               .BYTE 0 ; (uninited)
highScoreInitials:              .BYTE 0,0,0 ; (uninited)
                                .BYTE 0,0,0 ; (uninited)
                                .BYTE 0,0,0 ; (uninited)
                                .BYTE 0,0,0 ; (uninited)
                                .BYTE 0,0,0 ; (uninited)
                                .BYTE 0,0,0 ; (uninited)
                                .BYTE 0,0,0 ; (uninited)
                                .BYTE 0,0,0 ; (uninited)
                                .BYTE 0,0,0 ; (uninited)
byte_4F:                        .BYTE 0,0,0 ; (uninited)
p1ScoreTens:                    .BYTE 0 ; (uninited)
p1ScoreThousands:               .BYTE 0 ; (uninited)
p2ScoreTens:                    .BYTE 0 ; (uninited)
p2ScoreThousands:               .BYTE 0 ; (uninited)
numStartingShipsPerGame:        .BYTE 0 ; (uninited)
numShipsP1:                     .BYTE 0 ; (uninited)
numShipsP2:                     .BYTE 0 ; (uninited)
; Hyperspace flag:
; - 0x01 = successful
;   0x80 = unsuccessful (death)
;   0x00 = not active
hyperspaceFlag:                 .BYTE 0 ; (uninited)
timerStartGame:                 .BYTE 0 ; (uninited)
VBLANK_triggered:               .BYTE 0 ; (uninited)
fastTimer:                      .BYTE 0 ; (uninited)
slowTimer:                      .BYTE 0 ; (uninited)
NMI_count:                      .BYTE 0 ; (uninited)
rnd1:                           .BYTE 0 ; (uninited)
rnd2:                           .BYTE 0 ; (uninited)
direction:                      .BYTE 0 ; (uninited)
saucerShotDirection:            .BYTE 0 ; (uninited)
btn_edge_debounce:              .BYTE 0 ; (uninited)
ship_thrust_dH:                 .BYTE 0 ; (uninited)
ship_thrust_dV:                 .BYTE 0 ; (uninited)
timerPlayerFireSound:           .BYTE 0 ; (uninited)
timerSaucerFireSound:           .BYTE 0 ; (uninited)
timerBonusShipSound:            .BYTE 0 ; (uninited)
timerExplosionSound:            .BYTE 0 ; (uninited)
fireSoundFlagPlayer:            .BYTE 0 ; (uninited)
fireSoundFlagSaucer:            .BYTE 0 ; (uninited)
volFreqThumpSound:              .BYTE 0 ; (uninited)
timerThumpSoundOn:              .BYTE 0 ; (uninited)
timerThumpSoundOff:             .BYTE 0 ; (uninited)
io3200ShadowRegister:           .BYTE 0 ; (uninited)
CurrNumCredits:                 .BYTE 0 ; (uninited)
; 4=center_mult, 3..2=right_mult, 1..0=coinage
coinMultCredits:                .BYTE 0 ; (uninited)
slamSwitchFlag:                 .BYTE 0 ; (uninited)
totalCoinsForCredits:           .BYTE 0 ; (uninited)
byte_74:                        .BYTE 0 ; (uninited)
byte_75:                        .BYTE 0 ; (uninited)
byte_76:                        .BYTE 0 ; (uninited)
byte_77:                        .BYTE 0 ; (uninited)
                                .BYTE 0 ; (uninited)
                                .BYTE 0 ; (uninited)
coin_1_inp_length:              .BYTE 0 ; (uninited)
coin_2_inp_length:              .BYTE 0 ; (uninited)
coin_3_inp_length:              .BYTE 0 ; (uninited)
byte_7D:                        .BYTE 0 ; (uninited)
byte_7E:                        .BYTE 0 ; (uninited)
                                .BYTE 0 ; (uninited)
byte_80:                        .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
; end of 'ZEROPAGE'

; CA65 - replace stack with
; ===========================================================================

; Segment type: Regular
                                ;.segment STACK
                                .org $100
stack   .set $100
;stack:                         .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
;                               .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
; end of 'STACK'

; status
; 1-27 Asteroids
; 0xA0+ = exploding
; (4:3) = shape (0-3)
; (2:1) = size (0=small, 1=medium, 2=large)
;
; For CA65 replace with
.BSS
; ===========================================================================

; Segment type: Regular
                                ;.segment RAM
                                .org $200
P1RAM:                          .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited) ; Asteroids 1-27
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
; ship_Sts
; - 0x00  = in hyperspace?
; - 0x01  = player alive and active
; - 0xA0+ = player exploding
ship_Sts:                       .BYTE 0 ; (uninited)
; saucer_Sts
; - 0x00  = no saucer
; - 0x01  = small saucer
; - 0x02  = large saucer
; - 0xA0+ = saucer exploding
saucer_Sts:                     .BYTE 0 ; (uninited)
saucerShot_Sts:                 .BYTE 0,0 ; (uninited)
shipShot_Sts:                   .BYTE 0 ; (uninited)
                                .BYTE 0 ; (uninited)
                                .BYTE 0 ; (uninited)
                                .BYTE 0 ; (uninited)
; Horizontal Velocity 0-255 (255-192)=Left, 1-63=Right
asteroid_Vh:                    .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
ship_Vh:                        .BYTE 0 ; (uninited)
saucer_Vh:                      .BYTE 0 ; (uninited)
saucerShot_Vh:                  .BYTE 0,0 ; (uninited)
shipShot_Vh:                    .BYTE 0,0,0,0 ; (uninited)
; Vertical Velocity 0-255 (255-192)=Down, 1-63=Up
asteroid_Vv:                    .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
ship_Vv:                        .BYTE 0 ; (uninited)
saucer_Vv:                      .BYTE 0 ; (uninited)
saucerShot_Vv:                  .BYTE 0,0 ; (uninited)
shipShot_Vv:                    .BYTE 0,0,0,0 ; (uninited)
; Horiztonal Position High (0-31) 0=Left, 31=Right
asteroid_PHh:                   .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
ship_PHh:                       .BYTE 0 ; (uninited)
saucer_PHh:                     .BYTE 0 ; (uninited)
saucerShot_PHh:                 .BYTE 0,0 ; (uninited)
shipShot_PHh:                   .BYTE 0,0,0,0 ; (uninited)
; Vertical Position High (0-23), 0=Bottom, 23=Top
asteroid_PHv:                   .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
ship_PHv:                       .BYTE 0 ; (uninited)
saucer_PHv:                     .BYTE 0 ; (uninited)
saucerShot_PHv:                 .BYTE 0,0 ; (uninited)
shotShot_PHv:                   .BYTE 0,0,0,0 ; (uninited)
; Horizontal Position Low (0-255), 0=Left, 255=Right
asteroid_PLh:                   .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
ship_PLh:                       .BYTE 0 ; (uninited)
saucer_PLh:                     .BYTE 0 ; (uninited)
saucerShot_PLh:                 .BYTE 0,0 ; (uninited)
shipShot_PLh:                   .BYTE 0,0,0,0 ; (uninited)
; Vertical Position Low (0-255), 0=Bottom, 255=Top
asteroid_PLv:                   .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
ship_PLv:                       .BYTE 0 ; (uninited)
saucer_PLv:                     .BYTE 0 ; (uninited)
saucerShot_PLv:                 .BYTE 0,0 ; (uninited)
shipShot_PLv:                   .BYTE 0,0,0,0 ; (uninited)
startingAsteroidsPerWave:       .BYTE 0 ; (uninited)
currentNumberOfAsteroids:       .BYTE 0 ; (uninited)
saucerCountdownTimer:           .BYTE 0 ; (uninited)
starting_saucerCountdownTimer:  .BYTE 0 ; (uninited)
asteroid_hit_timer:             .BYTE 0 ; (uninited)
shipSpawnTimer:                 .BYTE 0 ; (uninited)
asteroidWaveTimer:              .BYTE 0 ; (uninited)
starting_ThumpCounter:          .BYTE 0 ; (uninited)
numAsteroidsLeftBeforeSaucer:   .BYTE 0 ; (uninited)
                                .BYTE 0 ; (uninited)
                                .BYTE 0 ; (uninited)
; this gets bank-switched into the same address space
; as the P1RAM block to save on code
P2RAM:                          .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
; end of 'RAM'

; ===========================================================================

; Segment type: Regular
                                ;.segment IN0
                                .org $2000
                                .BYTE 0 ; (uninited)
freq3kHz:                       .BYTE 0 ; (uninited)
halt:                           .BYTE 0 ; (uninited)
hyperspaceSwitch:               .BYTE 0 ; (uninited)
FireSwitch:                     .BYTE 0 ; (uninited)
diagStep:                       .BYTE 0 ; (uninited)
slamSwitch:                     .BYTE 0 ; (uninited)
selfTest:                       .BYTE 0 ; (uninited)
; end of 'IN0'

; ===========================================================================

; Segment type: Regular
                                ;.segment IN1
                                .org $2400
leftCoinSwitch:                 .BYTE 0 ; (uninited)
centerCoinSwitch:               .BYTE 0 ; (uninited)
rightCoinSwitch:                .BYTE 0 ; (uninited)
p1StartSwitch:                  .BYTE 0 ; (uninited)
p2StartSwitch:                  .BYTE 0 ; (uninited)
thrustSwitch:                   .BYTE 0 ; (uninited)
rotateRightSwitch:              .BYTE 0 ; (uninited)
rotateLeftSwitch:               .BYTE 0 ; (uninited)
; end of 'IN1'

; 0 = Free Play, 1 = 1 Coin 2 Credits, 2 = 1 Coin 1 Credit, 3 = 2 Coins 1 Credit
; ===========================================================================

; Segment type: Regular
                                ;.segment DSW1
                                .org $2800
coinage:                        .BYTE 0 ; (uninited)
; 0 = 1x & 4, 1 = 1x & 3, 2 = 2x & 4, 3 = 2x & 3
rightCoinMultiplier:            .BYTE 0 ; (uninited)
centerCoinMultiplierAndLives:   .BYTE 0 ; (uninited)
language:                       .BYTE 0 ; (uninited)
; end of 'DSW1'

; ===========================================================================

; Segment type: Regular
                                ;.segment DVGRAM
                                .org $4000
DVGRAM:                         .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
                                .BYTE 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ; (uninited)
; end of 'DVGRAM'

; For CA65 add the following line:
;
.segment "CODE"
; ===========================================================================

; Segment type: Regular
                                ;.segment DVGROM
                                .org $5000
DVGROM:                         .BYTE $80, $A0, $00, $00, $00, $70, $00, $00, $00, $90, $FF, $73, $FF, $92, $00, $70
                                .BYTE $00, $90, $FF, $77, $FF, $96, $00, $70, $FF, $92, $FF, $72, $00, $86, $00, $72
                                .BYTE $FE, $87, $FE, $77, $00, $92, $00, $76, $FE, $81, $00, $72, $FF, $96, $FF, $72
                                .BYTE $7F, $A3, $FF, $03, $00, $70, $00, $00, $FF, $96, $FF, $76, $FE, $81, $00, $76
                                .BYTE $00, $92, $00, $72, $FE, $87, $FE, $73, $00, $86, $00, $76, $FF, $92, $FF, $76
                                .BYTE $FC, $A1, $F4, $01, $00, $70, $00, $00, $DB, $F0, $00, $F9, $CF, $F0, $00, $F9
                                .BYTE $BB, $F0, $00, $F9, $AF, $F0, $00, $F9, $9B, $F0, $00, $F9, $8F, $F0, $00, $F9
                                .BYTE $7B, $F0, $00, $F9, $6F, $F0, $00, $F9, $5B, $F0, $00, $F9, $4F, $F0, $00, $F9
                                .BYTE $3B, $F0, $00, $F9, $2F, $F0, $7C, $D0, $E4, $A0, $5E, $11, $00, $70, $00, $00
                                .BYTE $80, $CA, $78, $CA, $D8, $CA, $C7, $CA, $2C, $CB, $9B, $CA, $F3, $CA, $F3, $CA
                                .BYTE $DD, $CA, $F3, $EA, $80, $A0, $90, $01, $00, $70, $00, $00, $73, $F5, $73, $F1
                                .BYTE $78, $F1, $77, $F1, $77, $F5, $78, $F5, $80, $31, $00, $02, $75, $F8, $70, $FD
                                .BYTE $71, $F8, $02, $FD, $2E, $CB, $63, $CB, $56, $CB, $63, $CB, $2C, $CB, $78, $CA
                                .BYTE $02, $CB, $78, $CA, $F3, $CA, $BA, $CA, $2C, $CB, $BA, $CA, $D8, $CA, $8D, $EA
                                .BYTE $C6, $FF, $C1, $FE, $C3, $F1, $CD, $F1, $C7, $F1, $C1, $FD, $D8, $1E, $32, $EC
                                .BYTE $00, $C4, $3C, $14, $0A, $46, $D8, $D8, $D0, $C8, $B5, $C8, $96, $C8, $80, $C8
                                .BYTE $0D, $F8, $78, $F8, $0D, $FD, $78, $F8, $09, $FD, $78, $F8, $0B, $F1, $78, $F8
                                .BYTE $0A, $F5, $78, $F8, $08, $F9, $78, $F8, $09, $F3, $78, $F8, $0D, $F3, $78, $F8
                                .BYTE $80, $54, $00, $06, $78, $F8, $0F, $F1, $78, $F8, $00, $D0, $00, $30, $80, $07
                                .BYTE $78, $F8, $80, $37, $80, $07, $78, $F8, $80, $37, $80, $03, $78, $F8, $E0, $40
                                .BYTE $A0, $02, $78, $F8, $C0, $35, $80, $03, $78, $F8, $80, $33, $00, $00, $78, $F8
                                .BYTE $A0, $42, $E0, $00, $78, $F8, $A0, $42, $E0, $04, $78, $F8, $E0, $44, $80, $07
                                .BYTE $78, $F8, $E0, $40, $A0, $06, $78, $F8, $00, $D0, $07, $F8, $78, $F8, $07, $FF
                                .BYTE $78, $F8, $03, $FF, $78, $F8, $C0, $40, $40, $02, $78, $F8, $80, $35, $00, $03
                                .BYTE $78, $F8, $00, $FB, $78, $F8, $40, $42, $C0, $00, $78, $F8, $40, $42, $C0, $04
                                .BYTE $78, $F8, $C0, $44, $00, $07, $78, $F8, $C0, $40, $40, $06, $78, $F8, $00, $D0
                                .BYTE $00, $30, $80, $06, $78, $F8, $80, $36, $80, $06, $78, $F8, $80, $36, $80, $02
                                .BYTE $78, $F8, $40, $31, $C0, $03, $78, $F8, $40, $35, $80, $02, $78, $F8, $80, $32
                                .BYTE $00, $00, $78, $F8, $C0, $33, $40, $01, $78, $F8, $C0, $33, $40, $05, $78, $F8
                                .BYTE $A0, $44, $80, $06, $78, $F8, $40, $31, $C0, $07, $78, $F8, $00, $D0, $F3, $C8
                                .BYTE $FF, $C8, $0D, $C9, $1A, $C9, $08, $F9, $79, $F9, $79, $FD, $7D, $F6, $79, $F6
                                .BYTE $8F, $F6, $8F, $F0, $7D, $F9, $78, $FA, $79, $F9, $79, $FD, $00, $D0, $0A, $F1
                                .BYTE $7A, $F1, $7D, $F9, $7E, $F5, $7E, $F1, $7D, $FD, $79, $F6, $7D, $F6, $79, $FD
                                .BYTE $79, $F1, $8B, $F5, $8A, $F3, $7D, $F9, $00, $D0, $0D, $F8, $7E, $F5, $7A, $F7
                                .BYTE $7A, $F3, $78, $F7, $79, $F8, $7A, $F3, $78, $F9, $7E, $F3, $7F, $F0, $7F, $F7
                                .BYTE $7A, $F5, $00, $D0, $09, $F0, $7B, $F1, $68, $F1, $7F, $F2, $7F, $F0, $69, $F6
                                .BYTE $7F, $F0, $78, $F7, $7A, $F7, $7B, $F1, $69, $F5, $69, $F9, $7F, $F2, $00, $D0
                                .BYTE $29, $C9, $0E, $F1, $CA, $F8, $0B, $F6, $00, $60, $80, $D6, $DB, $F6, $CA, $F8
                                .BYTE $DB, $F2, $DF, $F2, $CD, $F2, $CD, $F8, $CD, $F6, $DF, $F6, $00, $D0, $90, $52
                                .BYTE $A8, $52, $CC, $52, $F0, $52, $14, $53, $36, $53, $5A, $53, $7E, $53, $A2, $53
                                .BYTE $C6, $53, $EA, $53, $0E, $54, $32, $54, $56, $54, $7A, $54, $9E, $54, $C2, $54
                                .BYTE $0F, $F6, $C8, $FA, $BD, $F9, $00, $65, $00, $C3, $00, $65, $00, $C7, $B9, $F9
                                .BYTE $00, $D0, $CE, $F9, $CA, $F9, $00, $D0, $40, $46, $C0, $06, $00, $52, $30, $C4
                                .BYTE $C0, $41, $20, $C6, $B0, $64, $18, $C3, $48, $65, $E0, $C6, $20, $42, $C0, $C1
                                .BYTE $00, $D0, $D0, $50, $10, $C6, $60, $42, $C0, $C3, $00, $D0, $80, $46, $80, $06
                                .BYTE $E0, $43, $C0, $C4, $A0, $41, $60, $C6, $68, $64, $20, $C3, $90, $65, $C0, $C6
                                .BYTE $60, $42, $A0, $C1, $00, $D0, $90, $50, $30, $C6, $C0, $42, $80, $C3, $00, $D0
                                .BYTE $C0, $46, $40, $06, $E0, $43, $20, $C5, $60, $41, $80, $C6, $18, $64, $28, $C3
                                .BYTE $D0, $65, $98, $C6, $80, $42, $60, $C1, $00, $D0, $60, $50, $30, $C6, $20, $43
                                .BYTE $40, $C3, $00, $D0, $0E, $F7, $C0, $43, $80, $C5, $20, $41, $A0, $C6, $38, $60
                                .BYTE $28, $C3, $10, $66, $60, $C6, $A0, $42, $20, $C1, $00, $D0, $30, $50, $40, $C6
                                .BYTE $60, $43, $E0, $C2, $00, $D0, $20, $47, $C0, $05, $80, $43, $E0, $C5, $E0, $40
                                .BYTE $C0, $C6, $88, $60, $20, $C3, $48, $66, $30, $C6, $C0, $42, $E0, $C0, $00, $D0
                                .BYTE $10, $54, $40, $C6, $A0, $43, $A0, $C2, $00, $D0, $60, $47, $60, $05, $60, $43
                                .BYTE $40, $C6, $80, $40, $C0, $C6, $D8, $60, $10, $C3, $80, $66, $F0, $C5, $C0, $42
                                .BYTE $80, $C0, $00, $D0, $40, $54, $30, $C6, $E0, $43, $40, $C2, $00, $D0, $80, $47
                                .BYTE $00, $05, $20, $43, $80, $C6, $40, $40, $E0, $C6, $20, $61, $F8, $C2, $B0, $66
                                .BYTE $B0, $C5, $E0, $42, $40, $C0, $00, $D0, $80, $54, $30, $C6, $10, $52, $F0, $C0
                                .BYTE $00, $D0, $80, $47, $C0, $04, $E0, $42, $E0, $C6, $00, $40, $E0, $C6, $68, $61
                                .BYTE $D8, $C2, $D8, $66, $68, $C5, $E0, $42, $00, $C0, $00, $D0, $B0, $54, $20, $C6
                                .BYTE $20, $52, $B0, $C0, $00, $D0, $A0, $47, $60, $04, $80, $42, $20, $C7, $40, $44
                                .BYTE $E0, $C6, $B0, $61, $B0, $C2, $F8, $66, $20, $C5, $E0, $42, $40, $C4, $00, $D0
                                .BYTE $F0, $54, $10, $C6, $30, $52, $80, $C0, $00, $D0, $A0, $47, $00, $00, $40, $42
                                .BYTE $60, $C7, $80, $44, $C0, $C6, $F0, $61, $80, $C2, $10, $67, $D8, $C4, $C0, $42
                                .BYTE $80, $C4, $00, $D0, $40, $46, $E0, $C7, $30, $52, $40, $C0, $00, $D0, $A0, $47
                                .BYTE $60, $00, $E0, $41, $80, $C7, $E0, $44, $C0, $C6, $30, $62, $48, $C2, $20, $67
                                .BYTE $88, $C4, $C0, $42, $E0, $C4, $00, $D0, $A0, $46, $A0, $C7, $40, $52, $10, $C0
                                .BYTE $00, $D0, $80, $47, $C0, $00, $80, $41, $C0, $C7, $20, $45, $A0, $C6, $60, $62
                                .BYTE $10, $C2, $28, $67, $38, $C4, $A0, $42, $20, $C5, $00, $D0, $E0, $46, $60, $C7
                                .BYTE $40, $52, $30, $C4, $00, $D0, $80, $47, $00, $01, $20, $41, $E0, $C7, $60, $45
                                .BYTE $80, $C6, $98, $62, $D0, $C1, $28, $67, $18, $C0, $80, $42, $60, $C5, $00, $D0
                                .BYTE $40, $47, $20, $C7, $30, $52, $60, $C4, $00, $D0, $60, $47, $60, $01, $C0, $40
                                .BYTE $E0, $C7, $A0, $45, $60, $C6, $C0, $62, $90, $C1, $20, $67, $68, $C0, $60, $42
                                .BYTE $A0, $C5, $00, $D0, $80, $47, $C0, $C6, $30, $52, $90, $C4, $00, $D0, $20, $47
                                .BYTE $C0, $01, $30, $50, $00, $C6, $C0, $45, $20, $C6, $E0, $62, $48, $C1, $18, $67
                                .BYTE $B0, $C0, $20, $42, $C0, $C5, $00, $D0, $C0, $47, $60, $C6, $10, $52, $D0, $C4
                                .BYTE $00, $D0, $0A, $F7, $CE, $F8, $CD, $FD, $00, $63, $00, $C1, $00, $67, $00, $C1
                                .BYTE $CD, $F9, $00, $D0, $CD, $FE, $CD, $FA, $00, $D0, $0E, $F7, $7A, $F8, $79, $FD
                                .BYTE $00, $63, $00, $75, $00, $67, $00, $75, $79, $F9, $C0, $60, $80, $02, $9F, $D0
                                .BYTE $70, $FA, $72, $F2, $72, $F6, $70, $FE, $06, $F9, $72, $F8, $02, $F6, $00, $D0
                                .BYTE $70, $FB, $73, $F0, $71, $F5, $70, $F5, $75, $F5, $77, $F0, $03, $F0, $71, $F5
                                .BYTE $70, $F5, $75, $F5, $77, $F0, $03, $F8, $00, $D0, $70, $FB, $72, $F8, $06, $FF
                                .BYTE $72, $F8, $02, $F0, $00, $D0, $70, $FB, $72, $F0, $72, $F6, $70, $F6, $76, $F6
                                .BYTE $76, $F0, $03, $F8, $00, $D0, $70, $FB, $72, $F8, $05, $F7, $77, $F0, $00, $F7
                                .BYTE $72, $F8, $02, $F0, $00, $D0, $70, $FB, $72, $F8, $05, $F7, $77, $F0, $00, $F7
                                .BYTE $03, $F8, $00, $D0, $70, $FB, $72, $F8, $70, $F6, $06, $F6, $72, $F0, $70, $F6
                                .BYTE $76, $F8, $03, $F8, $00, $D0, $70, $FB, $00, $F7, $72, $F8, $00, $F3, $70, $FF
                                .BYTE $02, $F0, $00, $D0, $72, $F8, $06, $F0, $70, $FB, $02, $F0, $76, $F8, $03, $FF
                                .BYTE $00, $D0, $00, $F2, $72, $F6, $72, $F0, $70, $FB, $01, $FF, $00, $D0, $70, $FB
                                .BYTE $03, $F0, $77, $F7, $73, $F7, $03, $F0, $00, $D0, $00, $FB, $70, $FF, $72, $F8
                                .BYTE $02, $F0, $00, $D0, $70, $FB, $72, $F6, $72, $F2, $70, $FF, $02, $F0, $00, $D0
                                .BYTE $70, $FB, $72, $FF, $70, $FB, $01, $FF, $00, $D0, $70, $FB, $72, $F8, $70, $FF
                                .BYTE $76, $F8, $03, $F8, $00, $D0, $70, $FB, $72, $F8, $70, $F7, $76, $F8, $03, $F7
                                .BYTE $03, $F0, $00, $D0, $70, $FB, $72, $F8, $70, $FE, $76, $F6, $76, $F0, $02, $F2
                                .BYTE $72, $F6, $02, $F0, $00, $D0, $70, $FB, $72, $F8, $70, $F7, $76, $F8, $01, $F0
                                .BYTE $73, $F7, $02, $F0, $00, $D0, $72, $F8, $70, $F3, $76, $F8, $70, $F3, $72, $F8
                                .BYTE $01, $FF, $00, $D0, $02, $F0, $70, $FB, $06, $F0, $72, $F8, $01, $FF, $00, $D0
                                .BYTE $00, $FB, $70, $FF, $72, $F8, $70, $FB, $01, $FF, $00, $D0, $00, $FB, $71, $FF
                                .BYTE $71, $FB, $01, $FF, $00, $D0, $00, $FB, $70, $FF, $72, $F2, $72, $F6, $70, $FB
                                .BYTE $01, $FF, $00, $D0, $72, $FB, $06, $F8, $72, $FF, $02, $F0, $00, $D0, $02, $F0
                                .BYTE $70, $FA, $76, $F2, $02, $F8, $76, $F6, $02, $FE, $00, $D0, $00, $FB, $72, $F8
                                .BYTE $76, $FF, $72, $F8, $02, $F0, $00, $D0, $03, $F8, $00, $D0, $02, $F0, $70, $FB
                                .BYTE $02, $FF, $00, $D0, $00, $FB, $72, $F8, $70, $F7, $76, $F8, $70, $F7, $72, $F8
                                .BYTE $02, $F0, $00, $D0, $72, $F8, $70, $FB, $76, $F8, $00, $F7, $72, $F8, $02, $F7
                                .BYTE $00, $D0, $00, $FB, $70, $F7, $72, $F8, $00, $F3, $70, $FF, $02, $F0, $00, $D0
                                .BYTE $72, $F8, $70, $F3, $76, $F8, $70, $F3, $72, $F8, $01, $FF, $00, $D0, $00, $F3
                                .BYTE $72, $F8, $70, $F7, $76, $F8, $70, $FB, $03, $FF, $00, $D0, $00, $FB, $72, $F8
                                .BYTE $70, $FF, $02, $F0, $00, $D0, $72, $F8, $70, $FB, $76, $F8, $70, $FF, $00, $F3
                                .BYTE $72, $F8, $02, $F7, $00, $D0, $02, $F8, $70, $FB, $76, $F8, $70, $F7, $72, $F8
                                .BYTE $02, $F7, $00, $D0, $2C, $CB, $DD, $CA, $2E, $CB, $32, $CB, $3A, $CB, $41, $CB
                                .BYTE $48, $CB, $4F, $CB, $56, $CB, $5B, $CB, $63, $CB, $78, $CA, $80, $CA, $8D, $CA
                                .BYTE $93, $CA, $9B, $CA, $A3, $CA, $AA, $CA, $B3, $CA, $BA, $CA, $C1, $CA, $C7, $CA
                                .BYTE $CD, $CA, $D2, $CA, $D8, $CA, $DD, $CA, $E3, $CA, $EA, $CA, $F3, $CA, $FB, $CA
                                .BYTE $02, $CB, $08, $CB, $0E, $CB, $13, $CB, $1A, $CB, $1F, $CB, $26, $CB, $0B, $13
                                .BYTE $19, $2F, $41, $55, $6F, $77, $7D, $87, $91, $63, $56, $60, $6E, $3C, $EC, $4D
                                .BYTE $C0, $A4, $0A, $EA, $6C, $08, $00, $EC, $F2, $B0, $6E, $3C, $EC, $48, $5A, $B8
                                .BYTE $66, $92, $42, $9A, $82, $C3, $12, $0E, $12, $90, $4C, $4D, $F1, $A4, $12, $2D
                                .BYTE $D2, $0A, $64, $C2, $6C, $0F, $66, $CD, $82, $6C, $9A, $C3, $4A, $85, $C0, $A6
                                .BYTE $6E, $60, $6C, $9E, $0A, $C2, $42, $C4, $C2, $BA, $60, $49, $F0, $0C, $12, $C6
                                .BYTE $12, $B0, $00, $A6, $6E, $60, $58, $ED, $12, $B5, $E8, $29, $D2, $0E, $D8, $4C
                                .BYTE $82, $82, $70, $C2, $6C, $0B, $6E, $09, $E6, $B5, $92, $3E, $00, $A6, $6E, $60
                                .BYTE $6E, $C1, $6C, $C0, $00, $59, $62, $48, $66, $D2, $6D, $18, $4E, $9B, $64, $09
                                .BYTE $02, $A4, $0A, $ED, $C0, $18, $4E, $9B, $64, $08, $C2, $A4, $0A, $E8, $00, $20
                                .BYTE $4E, $9B, $64, $B8, $46, $0D, $20, $2F, $40, $00, $03, $06, $09, $0C, $10, $13
                                .BYTE $16, $19, $1C, $1F, $22, $25, $28, $2B, $2E, $31, $33, $36, $39, $3C, $3F, $41
                                .BYTE $44, $47, $49, $4C, $4E, $51, $53, $55, $58, $5A, $5C, $5E, $60, $62, $64, $66
                                .BYTE $68, $6A, $6B, $6D, $6F, $70, $71, $73, $74, $75, $76, $78, $79, $7A, $7A, $7B
                                .BYTE $7C, $7D, $7D, $7E, $7E, $7E, $7F, $7F, $7F, $7F, $00, $00, $00, $00, $00, $00
; end of 'DVGROM'

; ---------------------------------------------------------------------------
; For CA65 we need to fill from $5800-$6800 in the .BIN
; so we simply add the following line
;
.res $1000
; ===========================================================================

; Segment type: Pure code
                                ;.segment ROM
                                .org $6800
.ifdef APPLE_IIGS
                                jsr     apple_reset
.endif                                
                                JMP     RESET                                   ; Debugger? Off in the weeds? Do Reset.
; ---------------------------------------------------------------------------

START:                                                                          ; Reset Sound, Zero Out Sound Timers
.ifdef APPLE_IIGS
                                jsr     apple_start
.endif                                
                                JSR     init_sound
                                JSR     init_players                            ; init ships and scores

game_loop:
                                JSR     init_wave

wave_loop:                                                                      ; self test switch on?
                                LDA     selfTest

spin:                                                                           ; yes, spin
                                BMI     spin
                                LSR     VBLANK_triggered                        ; 4xNMI happened?
.ifndef APPLE_IIGS
                                BCC     wave_loop                               ; no, busy wait
.endif

loc_6815:                                                                       ; HALT
                                LDA     halt
.ifndef APPLE_IIGS
                                BMI     loc_6815                                ; wait for DVG
.endif
                                LDA     DVGRAM+1
                                EOR     #2                                      ; JMP $0402<->$0002
                                STA     DVGRAM+1
                                STA     $3000                                   ; Start DVG
                                STA     $3400                                   ; Reset Watchdog
                                INC     fastTimer                               ; Update Fast Timer
                                BNE     loc_682E
                                INC     slowTimer                               ; Update Slow Timer

loc_682E:                                                                       ; ping-pong DVG RAM $4000/$4400
                                LDX     #$40 ; '@'
                                AND     #2
                                BNE     loc_6836
                                LDX     #$44 ; 'D'

loc_6836:
                                LDA     #2
                                STA     dvg_curr_addr_lsb                       ; 0x02 (after JMP instruction)
                                STX     dvg_curr_addr_msb                       ; 0x40/0x44 (ping pong)
                                JSR     handle_start_end_turn_or_game
                                BCS     START
                                JSR     check_high_score
                                JSR     handle_high_score_entry
                                BPL     loc_6864                                ; go if new high score
                                JSR     display_high_score_table
                                BCS     loc_6864                                ; game not active, skip
                                LDA     timerStartGame                          ; waiting to start game?
                                BNE     loc_685E                                ; yes, skip
                                JSR     handle_fire
                                JSR     handle_hyperspace
                                JSR     handle_respawn_rot_thrust
                                JSR     handle_saucer

loc_685E:
                                JSR     update_and_render_objects
                                JSR     handle_shots                            ; still not finished???

loc_6864:                                                                       ; display (C), scores, extra ships
                                JSR     display_C_scores_ships
                                JSR     handle_sounds
                                LDA     #$7F ; ''                              ; X=0x7F
                                TAX                                             ; Y=0x7F
                                JSR     write_CURx4_cmd
                                JSR     update_prng
                                JSR     halt_dvg                                ; finished rendering
.ifdef APPLE_IIGS
                                jsr     apple_render_frame
.endif
                                LDA     asteroidWaveTimer
                                BEQ     loc_687E                                ; zero, skip
                                DEC     asteroidWaveTimer

loc_687E:                                                                       ; both zero?
                                ORA     currentNumberOfAsteroids
                                BNE     wave_loop                               ; no, go
                                BEQ     game_loop

; =============== S U B R O U T I N E =======================================


handle_start_end_turn_or_game:
                                LDA     numPlayers                              ; game active?
                                BEQ     check_freeplay                          ; no, skip
                                LDA     timerStartGame                          ; Time before next player starts
                                BNE     display_current_player                  ; timer running, go
                                JMP     handle_end_turn_or_game                 ; game active (playing)
; ---------------------------------------------------------------------------

display_current_player:                                                         ; update timer
                                DEC     timerStartGame
                                JSR     print_PLAYER_N                          ; show current player

loc_6895:
                                CLC
                                RTS
; ---------------------------------------------------------------------------

freeplay:                                                                       ; Free Credits!
                                LDA     #2
                                STA     CurrNumCredits                          ; Can Only Play A 2 Player Game, So Only Need To Add 2
                                BNE     check_start                             ; go

check_freeplay:                                                                 ; DIP Switch Settings Bitmap
                                LDA     coinMultCredits
                                AND     #3                                      ; coinage only. freeplay?
                                BEQ     freeplay                                ; yes, go
                                CLC
                                ADC     #7                                      ; calc coinage message
                                TAY                                             ; Into Y for the offset
                                LDA     placeP1HighScore
                                AND     placeP2HighScore
                                BPL     check_start
                                JSR     PrintPackedMsg                          ; display coinage

check_start:                                                                    ; credits?
                                LDY     CurrNumCredits
                                BEQ     loc_6895                                ; no, return
                                LDX     #1                                      ; 1 player
                                LDA     p1StartSwitch                           ; P1 start pressed?
                                BMI     start_game                              ; yes, go
                                CPY     #2                                      ; >=2 credits available?
                                BCC     display_push_start                      ; no, exit
                                LDA     p2StartSwitch                           ; P2 start pressed?
                                BPL     display_push_start                      ; no, exit
                                LDA     io3200ShadowRegister
                                ORA     #4                                      ; RAMSEL=1 (P2)
                                STA     io3200ShadowRegister
                                STA     $3200                                   ; output
                                JSR     init_players
                                JSR     init_wave
                                JSR     init_ship_position_velocity
                                LDA     numStartingShipsPerGame
                                STA     numShipsP2
                                LDX     #2                                      ; 2 players
                                DEC     CurrNumCredits

start_game:
                                STX     numPlayers
                                DEC     CurrNumCredits
                                LDA     io3200ShadowRegister
                                AND     #$F8 ; ''                              ; RAMSEL=0 (P1), lamps OFF
                                EOR     numPlayers                              ; player lamp ON
                                STA     io3200ShadowRegister
                                STA     $3200                                   ; output
                                JSR     init_ship_position_velocity
                                LDA     #1
                                STA     shipSpawnTimer
                                STA     P2RAM+$FA
                                LDA     #$92 ; ''
                                STA     starting_saucerCountdownTimer
                                STA     P2RAM+$F8
                                STA     P2RAM+$F7
                                STA     saucerCountdownTimer
                                LDA     #$7F ; ''
                                STA     asteroidWaveTimer
                                STA     P2RAM+$FB
                                LDA     #5
                                STA     numAsteroidsLeftBeforeSaucer
                                STA     P2RAM+$FD
                                LDA     #$FF
                                STA     placeP1HighScore                        ; flag no high score
                                STA     placeP2HighScore                        ; flag no high score
                                LDA     #$80 ; ''
                                STA     timerStartGame                          ; init timer
                                ASL     A                                       ; A=0
                                STA     curPlayer                               ; init current player
                                STA     curPlayer_x2
                                LDA     numStartingShipsPerGame
                                STA     numShipsP1                              ; init number of ships
                                LDA     #4
                                STA     volFreqThumpSound
                                STA     timerThumpSoundOff                      ; init thump sound
                                LDA     #48
                                STA     starting_ThumpCounter
                                STA     P2RAM+$FC
                                STA     $3E00                                   ; sound (noise reset)
                                RTS
; ---------------------------------------------------------------------------

display_push_start:
                                LDA     placeP1HighScore
                                AND     placeP1HighScore
                                BPL     loc_694C
                                LDA     fastTimer
                                AND     #$20 ; ' '                              ; display phase?
                                BNE     loc_694C                                ; no, skip
                                LDY     #6                                      ; "PUSH START"
                                JSR     PrintPackedMsg

loc_694C:
                                LDA     fastTimer
                                AND     #$F
                                BNE     loc_695E
                                LDA     #1
                                CMP     CurrNumCredits
                                ADC     #1
                                EOR     #1
                                EOR     io3200ShadowRegister
                                STA     io3200ShadowRegister

loc_695E:
                                CLC
                                RTS
; ---------------------------------------------------------------------------

handle_end_turn_or_game:
                                LDA     fastTimer
                                AND     #$3F ; '?'
                                BNE     loc_6970
                                LDA     starting_ThumpCounter
                                CMP     #8
                                BEQ     loc_6970
                                DEC     starting_ThumpCounter

loc_6970:
                                LDX     curPlayer
                                LDA     numShipsP1,X                            ; any ships left?
                                BNE     toggle_player                           ; yes, skip
                                LDA     shipShot_Sts
                                ORA     shipShot_Sts+1
                                ORA     shipShot_Sts+2
                                ORA     shipShot_Sts+3                          ; shot(s) still active?
                                BNE     toggle_player                           ; yes, skip
                                LDY     #7                                      ; "GAME OVER"
                                JSR     PrintPackedMsg
                                LDA     numPlayers
                                CMP     #2                                      ; 2 player game?
                                BCC     toggle_player                           ; no, skip
                                JSR     print_PLAYER_N                          ; display player

toggle_player:                                                                  ; player alive?
                                LDA     ship_Sts
                                BNE     loc_69CD                                ; yes, skip
                                LDA     shipSpawnTimer
                                CMP     #$80 ; ''
                                BNE     loc_69CD
                                LDA     #16
                                STA     shipSpawnTimer
                                LDX     numPlayers
                                LDA     numShipsP1
                                ORA     numShipsP2                              ; either play have ships left?
                                BEQ     loc_69CF                                ; no, exit
                                JSR     zero_saucer
                                DEX                                             ; 1 player game?
                                BEQ     loc_69CD                                ; yes, exit
                                LDA     #$80 ; ''
                                STA     timerStartGame
                                LDA     curPlayer
                                EOR     #1                                      ; toggler player
                                TAX
                                LDA     numShipsP1,X                            ; other player have any ships left?
                                BEQ     loc_69CD                                ; no, exit
                                STX     curPlayer                               ; update current player
                                LDA     #4                                      ; RAMSEL
                                EOR     io3200ShadowRegister                    ; toggle
                                STA     io3200ShadowRegister
                                STA     $3200                                   ; output
                                TXA
                                ASL     A                                       ; current player * 2
                                STA     curPlayer_x2

loc_69CD:
                                CLC
                                RTS
; ---------------------------------------------------------------------------

loc_69CF:
                                STX     numPlayersPreviousGame
                                LDA     #$FF
                                STA     numPlayers                              ; invalidate
                                JSR     init_sound
                                LDA     io3200ShadowRegister
                                AND     #$F8 ; ''                              ; RAMSEL=0, lamps OFF
                                ORA     #3                                      ; lamps ON
                                STA     io3200ShadowRegister
                                CLC
                                RTS
; End of function handle_start_end_turn_or_game


; =============== S U B R O U T I N E =======================================


print_PLAYER_N:
                                LDY     #1                                      ; "PLAYER"
                                JSR     PrintPackedMsg
                                LDY     curPlayer
                                INY
                                TYA
                                JSR     display_digit_A
                                RTS
; End of function print_PLAYER_N

; ---------------------------------------------------------------------------
                                .BYTE $71 ; q

; =============== S U B R O U T I N E =======================================


handle_shots:
                                LDX     #7                                      ; 8 values to check

chk_shot:                                                                       ; shot status
                                LDA     ship_Sts,X
                                BEQ     next_shot                               ; not active, skip
                                BPL     handle_active_shot                      ; active, go

next_shot:                                                                      ; next timer
                                DEX
                                BPL     chk_shot                                ; loop 'til done
                                RTS
; ---------------------------------------------------------------------------

handle_active_shot:                                                             ; offset to saucer
                                LDY     #$1C
                                CPX     #4                                      ; player shot?
                                BCS     loc_6A0A                                ; yes, go
                                DEY                                             ; offset to player
                                TXA
                                BNE     loc_6A0A                                ; (always)

loc_6A07:
                                DEY
                                BMI     next_shot

loc_6A0A:                                                                       ; player/saucer
                                LDA     P1RAM,Y
                                BEQ     loc_6A07                                ; not active, exit
                                BMI     loc_6A07                                ; exploding, exit
                                STA     byte_B                                  ; tmp status
                                LDA     asteroid_PLh,Y                          ; player/saucer PLh
                                SEC
                                SBC     ship_PLh,X                              ; - shot PLh
                                STA     byte_8
                                LDA     asteroid_PHh,Y                          ; player/saucer PHh
                                SBC     ship_PHh,X                              ; - shot PHh
                                LSR     A                                       ; /2
                                ROR     byte_8                                  ; low byte
                                ASL     A
                                BEQ     loc_6A34
                                BPL     loc_6A97
                                EOR     #$FE ; ''
                                BNE     loc_6A97
                                LDA     byte_8
                                EOR     #$FF
                                STA     byte_8

loc_6A34:                                                                       ; player/saucer PLv
                                LDA     asteroid_PLv,Y
                                SEC
                                SBC     ship_PLv,X                              ; - shot PLv
                                STA     byte_9
                                LDA     asteroid_PHv,Y                          ; player/saucer_PHv
                                SBC     ship_PHv,X                              ; - shot PHv
                                LSR     A                                       ; /2
                                ROR     byte_9                                  ; low byte
                                ASL     A
                                BEQ     loc_6A55
                                BPL     loc_6A97                                ; no hit, go
                                EOR     #$FE ; ''
                                BNE     loc_6A97
                                LDA     byte_9
                                EOR     #$FF
                                STA     byte_9

loc_6A55:
                                LDA     #$2A ; '*'
                                LSR     byte_B
                                BCS     loc_6A63
                                LDA     #$48 ; 'H'
                                LSR     byte_B
                                BCS     loc_6A63
                                LDA     #$84 ; ''

loc_6A63:                                                                       ; saucer?
                                CPX     #1
                                BCS     loc_6A69
                                ADC     #$1C

loc_6A69:
                                BNE     loc_6A77
                                ADC     #$12
                                LDX     saucer_Sts
                                DEX
                                BEQ     loc_6A75
                                ADC     #$12

loc_6A75:
                                LDX     #1

loc_6A77:
                                CMP     byte_8
                                BCC     loc_6A97
                                CMP     byte_9
                                BCC     loc_6A97
                                STA     byte_B
                                LSR     A
                                CLC
                                ADC     byte_B
                                STA     byte_B
                                LDA     byte_9
                                ADC     byte_8
                                BCS     loc_6A97
                                CMP     byte_B
                                BCS     loc_6A97
                                JSR     handle_object_hit

loc_6A94:
                                JMP     next_shot
; ---------------------------------------------------------------------------

loc_6A97:
                                DEY
                                BMI     loc_6A94
                                JMP     loc_6A0A
; End of function handle_shots

; Y=offset to source asteroid, X=offset to empty slot

; =============== S U B R O U T I N E =======================================


clone_asteroid_rnd_shape:
                                LDA     P1RAM,Y                                 ; asteroid status
                                AND     #7                                      ; bits 2-0
                                STA     byte_8
                                JSR     update_prng                             ; random asteroid shape
                                AND     #$18                                    ; bits 4-3 only
                                ORA     byte_8
                                STA     P1RAM,X                                 ; new status
                                LDA     asteroid_PLh,Y
                                STA     asteroid_PLh,X
                                LDA     asteroid_PHh,Y
                                STA     asteroid_PHh,X
                                LDA     asteroid_PLv,Y
                                STA     asteroid_PLv,X
                                LDA     asteroid_PHv,Y
                                STA     asteroid_PHv,X
                                LDA     asteroid_Vh,Y
                                STA     asteroid_Vh,X
                                LDA     asteroid_Vv,Y
                                STA     asteroid_Vv,X
                                RTS
; End of function clone_asteroid_rnd_shape


; =============== S U B R O U T I N E =======================================


copy_vector_list_from_table_to_dvgram:
                                STA     byte_B                                  ; table address (LSB)
                                STX     byte_C                                  ; table address (MSB)
; End of function copy_vector_list_from_table_to_dvgram


; =============== S U B R O U T I N E =======================================


copy_vector_list_to_avgram:
                                LDY     #0

loc_6AD9:
                                INY
                                LDA     (byte_B),Y                              ; SSSS -mYY (VEC) / 1111 smYY (SVEC)
                                EOR     byte_9                                  ; flag for flip Y (bit 2)
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram (cmd)
                                DEY
                                CMP     #$F0 ; ''                              ; SVEC?
                                BCS     is_svec                                 ; yes, go
                                CMP     #$A0 ; ''                              ; VEC?
                                BCS     loc_6AFF                                ; no, exit
                                LDA     (byte_B),Y                              ; YYYY YYYY
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                INY
                                INY
                                LDA     (byte_B),Y                              ; XXXX XXXX
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                INY
                                LDA     (byte_B),Y                              ; BBBB -mXX
                                EOR     byte_8                                  ; sign for X delta
                                ADC     extra_brightness
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram

loc_6AFC:
                                INY
                                BNE     loc_6AD9                                ; always

loc_6AFF:
                                DEY
                                JMP     update_dvg_curr_addr
; ---------------------------------------------------------------------------

is_svec:                                                                        ; BBBB SmXX
                                LDA     (byte_B),Y
                                EOR     byte_8                                  ; flag for flip X (bit 2)
                                CLC
                                ADC     extra_brightness
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                INY
                                BNE     loc_6AFC                                ; always
; End of function copy_vector_list_to_avgram


; =============== S U B R O U T I N E =======================================


handle_object_hit:
                                CPX     #1
                                BNE     loc_6B1B
                                CPY     #$1B                                    ; player hit?
                                BNE     loc_6B29                                ; no, skip
                                LDX     #0
                                LDY     #$1C                                    ; saucer

loc_6B1B:
                                TXA
                                BNE     loc_6B3C
                                LDA     #129
                                STA     shipSpawnTimer
                                LDX     curPlayer
                                DEC     numShipsP1,X                            ; dec number of ships
                                LDX     #0                                      ; offset to player ship

loc_6B29:                                                                       ; flag object exploding
                                LDA     #$A0 ; ''
                                STA     ship_Sts,X
                                LDA     #0
                                STA     ship_Vh,X
                                STA     ship_Vv,X                               ; zero object velocity
                                CPY     #$1B                                    ; asteroid?
                                BCC     loc_6B47                                ; yes, go
                                BCS     handle_saucer_hit                       ; no (saucer), go

loc_6B3C:
                                LDA     #0
                                STA     ship_Sts,X                              ; flag object inactive
                                CPY     #$1B                                    ; player?
                                BEQ     ship_hit_asteroid                       ; yes, go
                                BCS     handle_saucer_hit                       ; no (saucer), go

loc_6B47:
                                JSR     handle_asteroid_hit

explode_asteroid:                                                               ; (orginal) asteroid status
                                LDA     P1RAM,Y
                                AND     #3
                                EOR     #2
                                LSR     A
                                ROR     A
                                ROR     A
                                ORA     #$3F ; '?'
                                STA     timerExplosionSound
                                LDA     #$A0 ; ''                              ; flag exploding
                                STA     P1RAM,Y                                 ; store
                                LDA     #0
                                STA     asteroid_Vh,Y
                                STA     asteroid_Vv,Y                           ; zero asteroid velocity
                                RTS
; ---------------------------------------------------------------------------

ship_hit_asteroid:                                                              ; save object index
                                TXA
                                LDX     curPlayer
                                DEC     numShipsP1,X                            ; lose a ship
                                TAX                                             ; restore object index
                                LDA     #129                                    ; init spawn timer
                                STA     shipSpawnTimer
                                BNE     explode_asteroid                        ; always

handle_saucer_hit:
                                LDA     starting_saucerCountdownTimer
                                STA     saucerCountdownTimer
                                LDA     numPlayers                              ; real game?
                                BEQ     explode_asteroid                        ; no, go
                                STX     byte_D                                  ; save object index
                                LDX     curPlayer_x2
                                LDA     saucer_Sts
                                LSR     A                                       ; small saucer?
                                LDA     #$99 ; ''                              ; (99+1)*10 = 1,000 pts
                                BCS     loc_6B8B                                ; yes, skip
                                LDA     #$20 ; ' '                              ; 20x10 = 200 pts

loc_6B8B:
                                JSR     add_A_to_score
                                LDX     byte_D                                  ; restore object index
                                JMP     explode_asteroid
; End of function handle_object_hit


; =============== S U B R O U T I N E =======================================


handle_saucer:
                                LDA     fastTimer
                                AND     #3                                      ; time to update?
                                BEQ     loc_6B9A                                ; yes, go

locret_6B99:
                                RTS
; ---------------------------------------------------------------------------

loc_6B9A:
                                LDA     saucer_Sts
                                BMI     locret_6B99                             ; exploding? yes, exit
                                BEQ     handle_new_saucer                       ; no saucer? yes, go
                                JMP     handle_existing_saucer                  ; small/large saucer
; ---------------------------------------------------------------------------

handle_new_saucer:                                                              ; game active?
                                LDA     numPlayers
                                BEQ     loc_6BAF                                ; no, go
                                LDA     ship_Sts                                ; player active?
                                BEQ     locret_6B99                             ; no, return
                                BMI     locret_6B99                             ; exploding? yes, return

loc_6BAF:                                                                       ; non-zero?
                                LDA     asteroid_hit_timer
                                BEQ     loc_6BB7                                ; no, skip
                                DEC     asteroid_hit_timer

loc_6BB7:                                                                       ; time for saucer?
                                DEC     saucerCountdownTimer
                                BNE     locret_6B99                             ; no, exit
                                LDA     #18
                                STA     saucerCountdownTimer                    ; reinit countdown
                                LDA     asteroid_hit_timer                      ; asteroid hit recently?
                                BEQ     loc_6BD0                                ; no, skip
                                LDA     currentNumberOfAsteroids
                                BEQ     locret_6B99                             ; no asteroids, return
                                CMP     numAsteroidsLeftBeforeSaucer
                                BCS     locret_6B99                             ; too many asteroids, return

loc_6BD0:
                                LDA     starting_saucerCountdownTimer
                                SEC
                                SBC     #6
                                CMP     #32
                                BCC     loc_6BDD
                                STA     starting_saucerCountdownTimer

loc_6BDD:
                                LDA     #0
                                STA     saucer_PLh
                                STA     saucer_PHh
                                JSR     update_prng                             ; random position
                                LSR     A
                                ROR     saucer_PLv
                                LSR     A
                                ROR     saucer_PLv
                                LSR     A
                                ROR     saucer_PLv
                                CMP     #24
                                BCC     loc_6BFA
                                AND     #23

loc_6BFA:
                                STA     saucer_PHv
                                LDX     #$10
                                BIT     rnd2
                                BVS     loc_6C0F
                                LDA     #$1F
                                STA     saucer_PHh
                                LDA     #$FF
                                STA     saucer_PLh
                                LDX     #$F0 ; ''                              ; fixed velocity

loc_6C0F:
                                STX     saucer_Vh
                                LDX     #2                                      ; large saucer
                                LDA     starting_saucerCountdownTimer
                                BMI     loc_6C30
                                LDY     curPlayer_x2                            ; p1/p2 score
                                LDA     p1ScoreThousands,Y
                                CMP     #$30 ; '0'                              ; score over 30,000?
                                BCS     loc_6C2F                                ; yes, skip (always small saucer)
                                JSR     update_prng
                                STA     byte_8
                                LDA     starting_saucerCountdownTimer
                                LSR     A
                                CMP     byte_8
                                BCS     loc_6C30

loc_6C2F:                                                                       ; small saucer
                                DEX

loc_6C30:
                                STX     saucer_Sts
                                RTS
; ---------------------------------------------------------------------------

handle_existing_saucer:
                                LDA     fastTimer
                                ASL     A
                                BNE     loc_6C45
                                JSR     update_prng                             ; random Vv
                                AND     #3                                      ; 0-3
                                TAX
                                LDA     saucer_Vv_tbl,X                         ; get entry
                                STA     saucer_Vv

loc_6C45:                                                                       ; game active?
                                LDA     numPlayers
                                BEQ     loc_6C4E                                ; no, skip
                                LDA     shipSpawnTimer                          ; ship spawning?
                                BNE     locret_6C53                             ; yes, skip

loc_6C4E:
                                DEC     saucerCountdownTimer
                                BEQ     loc_6C54

locret_6C53:
                                RTS
; ---------------------------------------------------------------------------

loc_6C54:
                                LDA     #10
                                STA     saucerCountdownTimer
                                LDA     saucer_Sts
                                LSR     A                                       ; small saucer?
                                BEQ     handle_small_saucer                     ; yes, go
                                JSR     update_prng                             ; random shot direction
                                JMP     update_shot_direction
; ---------------------------------------------------------------------------

handle_small_saucer:
                                LDA     saucer_Vh
                                CMP     #$80 ; ''
                                ROR     A
                                STA     byte_C
                                LDA     ship_PLh
                                SEC
                                SBC     saucer_PLh
                                STA     byte_B
                                LDA     ship_PHh
                                SBC     saucer_PHh
                                ASL     byte_B
                                ROL     A
                                ASL     byte_B
                                ROL     A
                                SEC
                                SBC     byte_C
                                TAX
                                LDA     saucer_Vv
                                CMP     #$80 ; ''
                                ROR     A
                                STA     byte_C
                                LDA     ship_PLv
                                SEC
                                SBC     saucer_PLv
                                STA     byte_B
                                LDA     ship_PHv
                                SBC     saucer_PHv
                                ASL     byte_B
                                ROL     A
                                ASL     byte_B
                                ROL     A
                                SEC
                                SBC     byte_C
                                TAY
                                JSR     loc_76F0
                                STA     saucerShotDirection
                                JSR     update_prng
                                LDX     curPlayer_x2
                                LDY     p1ScoreThousands,X
                                CPY     #$35 ; '5'                              ; score over 35,000?
                                LDX     #0
                                BCC     loc_6CBA                                ; no, skip
                                INX

loc_6CBA:
                                AND     unk_6CCF,X
                                BPL     loc_6CC2
                                ORA     unk_6CD1,X

loc_6CC2:
                                ADC     saucerShotDirection

update_shot_direction:
                                STA     saucerShotDirection
                                LDY     #3
                                LDX     #1
                                STX     byte_E
                                JMP     find_free_shot_slot
; End of function handle_saucer

; ---------------------------------------------------------------------------
unk_6CCF:                       .BYTE $8F ; 
                                .BYTE $87 ; 
unk_6CD1:                       .BYTE $70 ; p
                                .BYTE $78 ; x
saucer_Vv_tbl:                  .BYTE $F0, 0, 0, $10
; detects leading edge of fire button press

; =============== S U B R O U T I N E =======================================


handle_fire:
                                LDA     numPlayers                              ; game active?
                                BEQ     locret_6CFC                             ; no, exit
                                ASL     FireSwitch                              ; fire button to C
                                ROR     btn_edge_debounce                       ; shift into bit 7
                                BIT     btn_edge_debounce                       ; test
                                BPL     locret_6CFC                             ; b7=0, not pressed, exit
                                BVS     locret_6CFC                             ; b6=1, was pressed, exit
                                LDA     shipSpawnTimer                          ; ship spawning?
                                BNE     locret_6CFC                             ; yes, exit
                                TAX
                                LDA     #3                                      ; offset shot0 timer - 1
                                STA     byte_E
                                LDY     #7                                      ; offset shot3 timer

find_free_shot_slot:                                                            ; get shot timer
                                LDA     ship_Sts,Y
                                BEQ     new_shot_fired                          ; not active, go
                                DEY                                             ; next shot timer
                                CPY     byte_E                                  ; done all shot timers?
                                BNE     find_free_shot_slot                     ; no, loop

locret_6CFC:
                                RTS
; ---------------------------------------------------------------------------

new_shot_fired:                                                                 ; offset to ship/saucer
                                STX     byte_D
                                LDA     #18
                                STA     ship_Sts,Y                              ; init shot timer
                                LDA     direction,X                             ; ship/saucer
                                JSR     get_thrust_cos
                                LDX     byte_D                                  ; was byte_2FA
                                CMP     #$80 ; ''                              ; down?
                                ROR     A
                                STA     byte_9
                                CLC
                                ADC     ship_Vh,X                               ; add Vh ship/saucer
                                BMI     loc_6D1E
                                CMP     #112                                    ; less than 112?
                                BCC     loc_6D24                                ; no, skip
                                LDA     #111                                    ; min = 111
                                BNE     loc_6D24

loc_6D1E:                                                                       ; more than 145?
                                CMP     #145
                                BCS     loc_6D24                                ; no, skip
                                LDA     #145                                    ; max = 145

loc_6D24:                                                                       ; update shot Vh
                                STA     ship_Vh,Y
                                LDA     direction,X                             ; ship/saucer
                                JSR     get_thrust_sin
                                LDX     byte_D
                                CMP     #$80 ; ''
                                ROR     A
                                STA     byte_C
                                CLC
                                ADC     ship_Vv,X
                                BMI     loc_6D41
                                CMP     #112                                    ; less than 112?
                                BCC     loc_6D47                                ; no, skip
                                LDA     #111                                    ; min = 111
                                BNE     loc_6D47

loc_6D41:                                                                       ; more than 145?
                                CMP     #145
                                BCS     loc_6D47                                ; no, skip
                                LDA     #145                                    ; max = 145

loc_6D47:                                                                       ; update shot Vv
                                STA     ship_Vv,Y
                                LDX     #0
                                LDA     byte_9
                                BPL     loc_6D51
                                DEX

loc_6D51:
                                STX     byte_8
                                LDX     byte_D
                                CMP     #$80 ; ''
                                ROR     A
                                CLC
                                ADC     byte_9
                                CLC
                                ADC     ship_PLh,X                              ; ship/saucer Ph
                                STA     ship_PLh,Y                              ; update shot Ph
                                LDA     byte_8
                                ADC     ship_PHh,X                              ; ship/saucer Ph
                                STA     ship_PHh,Y                              ; update shot Ph
                                LDX     #0
                                LDA     byte_C
                                BPL     loc_6D71
                                DEX

loc_6D71:
                                STX     byte_B
                                LDX     byte_D
                                CMP     #$80 ; ''
                                ROR     A
                                CLC
                                ADC     byte_C
                                CLC
                                ADC     ship_PLv,X                              ; ship/saucer Pv
                                STA     ship_PLv,Y                              ; update shot Pv
                                LDA     byte_B
                                ADC     ship_PHv,X                              ; ship/saucer Pv
                                STA     ship_PHv,Y                              ; update shot Pv
                                LDA     #$80 ; ''
                                STA     timerPlayerFireSound,X
                                RTS
; End of function handle_fire

; ---------------------------------------------------------------------------
                                .BYTE $D8 ; 

; =============== S U B R O U T I N E =======================================


handle_high_score_entry:
                                LDA     placeP1HighScore
                                AND     placeP2HighScore
                                BPL     high_score_entry
                                RTS
; ---------------------------------------------------------------------------

high_score_entry:
                                LDA     numPlayersPreviousGame
                                LSR     A
                                BEQ     loc_6DB4
                                LDY     #1                                      ; "PLAYER"
                                JSR     PrintPackedMsg
                                LDY     #2
                                LDX     placeP2HighScore
                                BPL     loc_6DA8
                                DEY

loc_6DA8:
                                STY     curPlayer
                                LDA     fastTimer
                                AND     #$10
                                BNE     loc_6DB4
                                TYA
                                JSR     display_digit_A

loc_6DB4:
                                LSR     curPlayer
                                JSR     set_RAMSEL_for_player
                                LDY     #2                                      ; "YOUR SCORE IS ONE OF THE TEN BEST"
                                JSR     PrintPackedMsg
                                LDY     #3                                      ; "PLEASE ENTER YOUR INITIALS"
                                JSR     PrintPackedMsg
                                LDY     #4                                      ; "PUSH ROTATE TO SELECT LETTER"
                                JSR     PrintPackedMsg
                                LDY     #5                                      ; "PUSH HYPERSPACE WHEN LETTER IS CORRECT"
                                JSR     PrintPackedMsg
                                LDA     #$20 ; ' '
                                STA     globalScale
                                LDA     #$64 ; 'd'
                                LDX     #$39 ; '9'
                                JSR     write_CURx4_cmd
                                LDA     #$70 ; 'p'
                                JSR     set_scale_A_bright_0
                                LDX     curPlayer
                                LDY     $32,X
                                STY     byte_B
                                TYA
                                CLC
                                ADC     letterHighScoreEntry
                                STA     byte_C
                                JSR     display_initial
                                LDY     byte_B
                                INY
                                JSR     display_initial
                                LDY     byte_B
                                INY
                                INY
                                JSR     display_initial
                                LDA     hyperspaceSwitch                        ; read hyperspace button
                                ROL     A                                       ; shift into C
                                ROL     btn_edge_debounce                       ; shift into bit0
                                LDA     btn_edge_debounce
                                AND     #$1F                                    ; low 5 bits
                                CMP     #7                                      ; 00111?
                                BNE     loc_6E2E                                ; no, exit
                                INC     letterHighScoreEntry
                                LDA     letterHighScoreEntry
                                CMP     #3
                                BCC     loc_6E22
                                LDX     curPlayer
                                LDA     #$FF
                                STA     placeP1HighScore,X

loc_6E15:
                                LDX     #0
                                STX     curPlayer
                                STX     letterHighScoreEntry
                                LDX     #$F0 ; ''
                                STX     slowTimer
                                JMP     set_RAMSEL_for_player
; ---------------------------------------------------------------------------

loc_6E22:
                                INC     byte_C
                                LDX     byte_C
                                LDA     #$F4 ; ''
                                STA     slowTimer
                                LDA     #$B
                                STA     highScoreInitials,X

loc_6E2E:
                                LDA     slowTimer
                                BNE     loc_6E3A
                                LDA     #$FF
                                STA     placeP1HighScore
                                STA     placeP2HighScore
                                BMI     loc_6E15

loc_6E3A:
                                LDA     fastTimer
                                AND     #7
                                BNE     loc_6E71
                                LDA     rotateLeftSwitch
                                BPL     loc_6E49
                                LDA     #1
                                BNE     loc_6E50

loc_6E49:
                                LDA     rotateRightSwitch
                                BPL     loc_6E71
                                LDA     #$FF

loc_6E50:
                                LDX     byte_C
                                CLC
                                ADC     highScoreInitials,X
                                BMI     loc_6E67
                                CMP     #$B
                                BCS     loc_6E69
                                CMP     #1
                                BEQ     loc_6E63
                                LDA     #0
                                BEQ     loc_6E6F

loc_6E63:
                                LDA     #$B
                                BNE     loc_6E6F

loc_6E67:
                                LDA     #$24 ; '$'

loc_6E69:
                                CMP     #$25 ; '%'
                                BCC     loc_6E6F
                                LDA     #0

loc_6E6F:
                                STA     highScoreInitials,X

loc_6E71:
                                LDA     #0
                                RTS
; End of function handle_high_score_entry


; =============== S U B R O U T I N E =======================================


handle_hyperspace:
                                LDA     numPlayers
                                BEQ     locret_6ED7                             ; not a real game, exit
                                LDA     ship_Sts
                                BMI     locret_6ED7                             ; exploding, exit
                                LDA     shipSpawnTimer
                                BNE     locret_6ED7
                                LDA     hyperspaceSwitch                        ; button pressed?
                                BPL     locret_6ED7                             ; no, exit
                                LDA     #0                                      ; flag hyperspace?
                                STA     ship_Sts
                                STA     ship_Vh
                                STA     ship_Vv                                 ; zero ship velocity
                                LDA     #48
                                STA     shipSpawnTimer
                                JSR     update_prng                             ; random horizontal position
                                AND     #$1F
                                CMP     #29
                                BCC     loc_6EA2
                                LDA     #28

loc_6EA2:
                                CMP     #3
                                BCS     loc_6EA8
                                LDA     #3

loc_6EA8:                                                                       ; 3-28
                                STA     ship_PHh
                                LDX     #5

loc_6EAD:                                                                       ; random vertical position
                                JSR     update_prng
                                DEX
                                BNE     loc_6EAD
                                AND     #$1F
                                INX                                             ; =1 (successful)
                                CMP     #24
                                BCC     loc_6EC6
                                AND     #7
                                ASL     A
                                ADC     #4
                                CMP     currentNumberOfAsteroids
                                BCC     loc_6EC6
                                LDX     #$80 ; ''                              ; flag unsuccessful (death)

loc_6EC6:
                                CMP     #21
                                BCC     loc_6ECC
                                LDA     #20

loc_6ECC:
                                CMP     #3
                                BCS     loc_6ED2
                                LDA     #3

loc_6ED2:                                                                       ; 3-20
                                STA     ship_PHv
                                STX     hyperspaceFlag

locret_6ED7:
                                RTS
; End of function handle_hyperspace


; =============== S U B R O U T I N E =======================================


init_players:
                                LDA     #2
                                STA     startingAsteroidsPerWave
                                LDX     #3
                                LSR     centerCoinMultiplierAndLives
                                BCS     loc_6EE5
                                INX

loc_6EE5:
                                STX     numStartingShipsPerGame
                                LDA     #0
                                LDX     #4                                      ; 4 flags, 4 timers, 4 score bytes

loc_6EEB:                                                                       ; init flag
                                STA     ship_Sts,X
                                STA     shipShot_Sts,X                          ; init timer
                                STA     byte_4F+2,X                             ; zero player score
                                DEX                                             ; next byte
                                BPL     loc_6EEB                                ; loop until done
                                STA     currentNumberOfAsteroids
                                RTS
; End of function init_players


; =============== S U B R O U T I N E =======================================


init_sound:
                                LDA     #0                                      ; turn off sound
                                STA     $3600                                   ; sound (explosion)
                                STA     $3A00                                   ; sound (thump)
                                STA     $3C00                                   ; sound (saucer)
                                STA     $3C01                                   ; sound (saucer fire)
                                STA     $3C03                                   ; sound (ship thrust)
                                STA     $3C04                                   ; sound (ship fire)
                                STA     $3C05                                   ; sound (bonus life)
                                STA     timerExplosionSound
                                STA     timerPlayerFireSound
                                STA     timerSaucerFireSound
                                STA     timerBonusShipSound
                                RTS
; End of function init_sound


; =============== S U B R O U T I N E =======================================


display_initial:
                                LDA     highScoreInitials,Y                     ; get initial
                                ASL     A                                       ; convert to char code
                                TAY                                             ; space?
                                BNE     display_char_code_Y                     ; no, display
                                LDA     placeP1HighScore
                                AND     placeP2HighScore                        ; entered as <space>?
                                BMI     display_char_code_Y                     ; yes, display
.ifndef APPLE_IIGS
                                LDA     #$72 ; 'r'                              ; brightness=7, S=0, X=2
                                LDX     #$F8 ; ''                              ; cmd=SVEC, s=-ve, Y=0
                                JSR     write_AX_to_avgram
                                LDA     #1                                      ; brightness=0, S=0, X=0
                                LDX     #$F8 ; ''                              ; cmd=SVEC, s=-ve, Y=0
                                JMP     write_AX_to_avgram
.else
; *** TBD add underline character
																rts
.endif
                                
; End of function display_initial


; =============== S U B R O U T I N E =======================================


display_char_code_Y:
.ifndef APPLE_IIGS
                                LDX     DVGROM+$6D5,Y                           ; chr fn
                                LDA     DVGROM+$6D4,Y                           ; chr fn
                                JMP     write_AX_to_avgram
.else
																tya
																ldy			#0
																sta			(dvg_curr_addr_lsb),y
																iny
																lda			#OP_CHR
																sta			(dvg_curr_addr_lsb),y
																jmp			update_dvg_curr_addr
.endif                                
; End of function display_char_code_Y


; =============== S U B R O U T I N E =======================================


display_extra_ships:
                                BEQ     locret_6F56
                                STY     byte_8
                                LDX     #213                                    ; Y coord (x4=852)
                                LDY     #$E0 ; ''
                                STY     globalScale
                                JSR     write_CURx4_cmd

.ifndef APPLE_IIGS
loc_6F4B:
                                LDX     #$DA ; ''
                                LDA     #$54 ; 'T'                              ; addr=0x54DA
                                JSR     write_JSR_cmd                           ; display extra ships?
                                DEC     byte_8
                                BNE     loc_6F4B
.else                                
                                ldy     #0
                                lda     #OP_LIFE
loc_6F4B:
                                sta     (dvg_curr_addr_lsb),y
                                iny
                                sta     (dvg_curr_addr_lsb),y
                                iny
                                dec     byte_8
                                bne     loc_6F4B
                                dey
                                jsr     update_dvg_curr_addr
.endif                                

locret_6F56:
                                RTS
; End of function display_extra_ships


; =============== S U B R O U T I N E =======================================


update_and_render_objects:
                                LDX     #34                                     ; 34 objects to ???

loc_6F59:                                                                       ; get entry
                                LDA     P1RAM,X
                                BNE     handle_object_entry                     ; non-zero entry, handle it

next_object:                                                                    ; next value
                                DEX
                                BPL     loc_6F59                                ; loop 'til done
                                RTS
; ---------------------------------------------------------------------------

handle_object_entry:                                                            ; status < 128, go
                                BPL     object_ok
                                JSR     negate_A
                                LSR     A
                                LSR     A
                                LSR     A
                                LSR     A                                       ; high nibble
                                CPX     #$1B                                    ; playerFlag?
                                BNE     loc_6F76                                ; no, skip
                                LDA     fastTimer
                                AND     #1
                                LSR     A                                       ; wtf?
                                BEQ     loc_6F77                                ; always!?!

loc_6F76:
                                SEC

loc_6F77:
                                ADC     P1RAM,X
                                BMI     loc_6FA1
                                CPX     #$1B                                    ; playerFlag?
                                BEQ     loc_6F93                                ; yes, go
                                BCS     loc_6F99
                                DEC     currentNumberOfAsteroids
                                BNE     loc_6F8C
                                LDY     #$7F ; ''
                                STY     asteroidWaveTimer

loc_6F8C:
                                LDA     #0
                                STA     P1RAM,X
                                BEQ     next_object

loc_6F93:
                                JSR     init_ship_position_velocity
                                JMP     loc_6F8C
; ---------------------------------------------------------------------------

loc_6F99:
                                LDA     starting_saucerCountdownTimer
                                STA     saucerCountdownTimer
                                BNE     loc_6F8C

loc_6FA1:
                                STA     P1RAM,X
                                AND     #$F0 ; ''
                                CLC
                                ADC     #$10
                                CPX     #$1B                                    ; PlayerFlag?
                                BNE     loc_6FAF                                ; no, skip
                                LDA     #0

loc_6FAF:
                                TAY
                                LDA     asteroid_PLh,X
                                STA     byte_4
                                LDA     asteroid_PHh,X
                                STA     byte_5
                                LDA     asteroid_PLv,X
                                STA     byte_6
                                LDA     asteroid_PHv,X
                                STA     byte_7
                                JMP     jsr_display_object
; ---------------------------------------------------------------------------

object_ok:
                                CLC
                                LDY     #0
                                LDA     asteroid_Vh,X                           ; object Vh
                                BPL     loc_6FD0                                ; +ve, skip
                                DEY

loc_6FD0:                                                                       ; object Ph += Vh
                                ADC     asteroid_PLh,X
                                STA     asteroid_PLh,X
                                STA     byte_4
                                TYA
                                ADC     asteroid_PHh,X                          ; object Ph += Vh
                                CMP     #32                                     ; max?
                                BCC     loc_6FEC                                ; no, skip
                                AND     #31                                     ; max=31
                                CPX     #$1C                                    ; SaucerFlag?
                                BNE     loc_6FEC                                ; no, go
                                JSR     zero_saucer
                                JMP     next_object
; ---------------------------------------------------------------------------

loc_6FEC:
                                STA     asteroid_PHh,X
                                STA     byte_5
                                CLC
                                LDY     #0
                                LDA     asteroid_Vv,X                           ; object Vv
                                BPL     loc_6FFB                                ; +ve, skip
                                LDY     #$FF

loc_6FFB:                                                                       ; object Pv += Vv
                                ADC     asteroid_PLv,X
                                STA     asteroid_PLv,X
                                STA     byte_6
                                TYA
                                ADC     asteroid_PHv,X                          ; object Pv += Vv
                                CMP     #24                                     ; max?
                                BCC     loc_7013                                ; no, skip
                                BEQ     loc_7011
                                LDA     #23                                     ; max=23
                                BNE     loc_7013                                ; (always)

loc_7011:
                                LDA     #0

loc_7013:
                                STA     asteroid_PHv,X
                                STA     byte_7
                                LDA     P1RAM,X                                 ; object status
                                LDY     #$E0 ; ''
                                LSR     A                                       ; bit 0
                                BCS     jsr_display_object                      ; b0=1, go
                                LDY     #$F0 ; ''
                                LSR     A                                       ; bit 1
                                BCS     jsr_display_object                      ; b1=1, go
                                LDY     #0                                      ; globalscale

jsr_display_object:
                                JSR     display_object
                                JMP     next_object
; End of function update_and_render_objects


; =============== S U B R O U T I N E =======================================


zero_saucer:
                                LDA     starting_saucerCountdownTimer
                                STA     saucerCountdownTimer
                                LDA     #0
                                STA     saucer_Sts
                                STA     saucer_Vh
                                STA     saucer_Vv
                                RTS
; End of function zero_saucer


; =============== S U B R O U T I N E =======================================


handle_respawn_rot_thrust:
                                LDA     numPlayers
                                BEQ     locret_7085
                                LDA     ship_Sts
                                BMI     locret_7085                             ; exploding - exit
                                LDA     shipSpawnTimer
                                BEQ     check_rot_left
                                DEC     shipSpawnTimer                          ; still spawning?
                                BNE     locret_7085                             ; yes, exit
                                LDY     hyperspaceFlag
                                BMI     loc_706F                                ; unsuccessful - go
                                BNE     end_hyperspace                          ; successful - go
                                JSR     check_near_objs_and_extend_spawn        ; objects too close?
                                BNE     loc_7081                                ; yes, exit
                                LDY     saucer_Sts
                                BEQ     end_hyperspace                          ; no saucer - go
                                LDY     #2
                                STY     shipSpawnTimer
                                RTS
; ---------------------------------------------------------------------------

end_hyperspace:                                                                 ; flag alive and active
                                LDA     #1
                                STA     ship_Sts
                                BNE     loc_7081                                ; always go

loc_706F:                                                                       ; flag exploding
                                LDA     #$A0 ; ''
                                STA     ship_Sts
                                LDX     #$3E ; '>'
                                STX     timerExplosionSound
                                LDX     curPlayer
                                DEC     numShipsP1,X                            ; dec number of ships
                                LDA     #129
                                STA     shipSpawnTimer

loc_7081:                                                                       ; flag inactive
                                LDA     #0
                                STA     hyperspaceFlag

locret_7085:
                                RTS
; ---------------------------------------------------------------------------

check_rot_left:                                                                 ; left button?
                                LDA     rotateLeftSwitch
                                BPL     check_rot_right                         ; no, skip
                                LDA     #3
                                BNE     update_dir                              ; always go

check_rot_right:                                                                ; right button?
                                LDA     rotateRightSwitch
                                BPL     check_thrust                            ; no, skip
                                LDA     #$FD                                    ; -3

update_dir:
                                CLC
                                ADC     direction                               ; calc direction
                                STA     direction                               ; update

check_thrust:
                                LDA     fastTimer
                                LSR     A
                                BCS     locret_7085                             ; exit
                                LDA     thrustSwitch                            ; thrust button?
                                BPL     loc_70E1                                ; no, go
                                LDA     #$80 ; ''
                                STA     $3C03                                   ; sound (ship thrust)
                                LDY     #0
                                LDA     direction
                                JSR     get_thrust_cos
                                BPL     loc_70B4
                                DEY

loc_70B4:
                                ASL     A
                                CLC
                                ADC     ship_thrust_dH
                                TAX
                                TYA
                                ADC     ship_Vh
                                JSR     calc_thrust_delta
                                STA     ship_Vh
                                STX     ship_thrust_dH
                                LDY     #0
                                LDA     direction
                                JSR     get_thrust_sin
                                BPL     loc_70CF
                                DEY

loc_70CF:
                                ASL     A
                                CLC
                                ADC     ship_thrust_dV
                                TAX
                                TYA
                                ADC     ship_Vv
                                JSR     calc_thrust_delta
                                STA     ship_Vv
                                STX     ship_thrust_dV
                                RTS
; ---------------------------------------------------------------------------

loc_70E1:
                                LDA     #0
                                STA     $3C03                                   ; sound (ship thrust)
                                LDA     ship_Vh
                                ORA     ship_thrust_dH
                                BEQ     loc_7105
                                LDA     ship_Vh
                                ASL     A
                                LDX     #$FF
                                CLC
                                EOR     #$FF
                                BMI     loc_70FA
                                INX
                                SEC

loc_70FA:
                                ADC     ship_thrust_dH
                                STA     ship_thrust_dH
                                TXA
                                ADC     ship_Vh
                                STA     ship_Vh

loc_7105:
                                LDA     ship_thrust_dV
                                ORA     ship_Vv
                                BEQ     locret_7124
                                LDA     ship_Vv
                                ASL     A
                                LDX     #$FF
                                CLC
                                EOR     #$FF
                                BMI     loc_7119
                                SEC
                                INX

loc_7119:
                                ADC     ship_thrust_dV
                                STA     ship_thrust_dV
                                TXA
                                ADC     ship_Vv
                                STA     ship_Vv

locret_7124:
                                RTS
; End of function handle_respawn_rot_thrust


; =============== S U B R O U T I N E =======================================


calc_thrust_delta:
                                BMI     loc_7130
                                CMP     #64
                                BCC     locret_7138
                                LDX     #$FF
                                LDA     #63
                                RTS
; ---------------------------------------------------------------------------

loc_7130:
                                CMP     #192
                                BCS     locret_7138
                                LDX     #1
                                LDA     #192

locret_7138:
                                RTS
; End of function calc_thrust_delta

; sets Z flag if no coincident objects

; =============== S U B R O U T I N E =======================================


check_near_objs_and_extend_spawn:
                                LDX     #28                                     ; 29 objects to check

loc_713B:                                                                       ; get object status
                                LDA     P1RAM,X
                                BEQ     loc_715E                                ; not active, skip
                                LDA     asteroid_PHh,X
                                SEC
                                SBC     ship_PHh
                                CMP     #4                                      ; object, ship PHh within 4?
                                BCC     loc_714F                                ; yes, go
                                CMP     #$FC ; ''
                                BCC     loc_715E                                ; no, skip

loc_714F:
                                LDA     asteroid_PHv,X
                                SEC
                                SBC     ship_PHv
                                CMP     #4                                      ; object, ship PHv within 4?
                                BCC     extend_spawn                            ; yes, go
                                CMP     #$FC ; ''
                                BCS     extend_spawn                            ; yes, go

loc_715E:                                                                       ; next object
                                DEX
                                BPL     loc_713B                                ; loop thru all objects
                                INX                                             ; X=0, set Z flag
                                RTS
; ---------------------------------------------------------------------------

extend_spawn:                                                                   ; reset Z flag
                                INC     shipSpawnTimer
                                RTS
; End of function check_near_objs_and_extend_spawn

; ---------------------------------------------------------------------------
                                .BYTE $90 ; 

; =============== S U B R O U T I N E =======================================


init_wave:
                                LDX     #26                                     ; 26+1 asteroids
                                LDA     asteroidWaveTimer
                                BNE     loc_71DF
                                LDA     saucer_Sts                              ; saucer active?
                                BNE     locret_71E7                             ; yes, return
                                STA     saucer_Vh
                                STA     saucer_Vv                               ; zero saucer vertical velocity
                                INC     numAsteroidsLeftBeforeSaucer
                                LDA     numAsteroidsLeftBeforeSaucer
                                CMP     #11                                     ; max value
                                BCC     loc_7187                                ; no, skip
                                DEC     numAsteroidsLeftBeforeSaucer            ; adjust to max

loc_7187:
                                LDA     startingAsteroidsPerWave
                                CLC
                                ADC     #2                                      ; 2 more per wave
                                CMP     #11                                     ; max number of asteroids?
                                BCC     loc_7193                                ; OK, skip
                                LDA     #11                                     ; limit to 11

loc_7193:
                                STA     currentNumberOfAsteroids
                                STA     startingAsteroidsPerWave
                                STA     byte_8                                  ; store as temp counter
                                LDY     #28                                     ; offset to ship

init_next_asteroid:                                                             ; random velocity
                                JSR     update_prng
                                AND     #$18                                    ; (4:3) = rnd shape
                                ORA     #4                                      ; (2:1) = 10b = large
                                STA     P1RAM,X                                 ; set asteroid status
                                JSR     set_asteroid_velocity
                                JSR     update_prng                             ; random position
                                LSR     A
                                AND     #$1F                                    ; 5 bits of high byte
                                BCC     start_bottom
                                CMP     #$18
                                BCC     start_left
                                AND     #$17

start_left:                                                                     ; y coord (high byte)
                                STA     asteroid_PHv,X
                                LDA     #0
                                STA     asteroid_PHh,X
                                STA     asteroid_PLh,X                          ; x coord = 0
                                BEQ     loc_71D0

start_bottom:                                                                   ; x coord (high byte)
                                STA     asteroid_PHh,X
                                LDA     #0
                                STA     asteroid_PHv,X                          ; y coord = 0
                                STA     asteroid_PLv,X

loc_71D0:                                                                       ; offset for next asteroid
                                DEX
                                DEC     byte_8                                  ; done all asteroids for the wave?
                                BNE     init_next_asteroid                      ; no, loop
                                LDA     #127
                                STA     saucerCountdownTimer
                                LDA     #48
                                STA     starting_ThumpCounter

loc_71DF:
                                LDA     #0

loc_71E1:                                                                       ; flag asteroid as inactive
                                STA     P1RAM,X
                                DEX                                             ; offset for next asteriod
                                BPL     loc_71E1                                ; loop through remaining entries

locret_71E7:
                                RTS
; End of function init_wave


; =============== S U B R O U T I N E =======================================


init_ship_position_velocity:
                                LDA     #$60 ; '`'
                                STA     ship_PLh
                                STA     ship_PLv
                                LDA     #0
                                STA     ship_Vh
                                STA     ship_Vv                                 ; zero ship velocity
                                LDA     #$10
                                STA     ship_PHh                                ; x=$1060 = 4192
                                LDA     #$C
                                STA     ship_PHv                                ; y=$0C60 = 3168
                                RTS
; End of function init_ship_position_velocity

; Y=source asteroid, X=new asteroid

; =============== S U B R O U T I N E =======================================


set_asteroid_velocity:
                                JSR     update_prng
                                AND     #$8F ; ''
                                BPL     loc_720C
                                ORA     #$F0 ; ''

loc_720C:
                                CLC
                                ADC     asteroid_Vh,Y                           ; source velocity
                                JSR     limit_asteroid_velocity
                                STA     asteroid_Vh,X                           ; new velocity
                                JSR     update_prng
                                JSR     update_prng
                                JSR     update_prng
                                JSR     update_prng
                                AND     #$8F ; ''
                                BPL     loc_7228
                                ORA     #$F0 ; ''

loc_7228:
                                CLC
                                ADC     asteroid_Vv,Y                           ; source velocity
                                JSR     limit_asteroid_velocity
                                STA     asteroid_Vv,X                           ; new velocity
                                RTS
; End of function set_asteroid_velocity


; =============== S U B R O U T I N E =======================================


limit_asteroid_velocity:
                                BPL     loc_7242
                                CMP     #256-31
                                BCS     loc_723B
                                LDA     #256-31

loc_723B:
                                CMP     #256-5
                                BCC     locret_724E
                                LDA     #256-6
                                RTS
; ---------------------------------------------------------------------------

loc_7242:
                                CMP     #6
                                BCS     loc_7248
                                LDA     #6

loc_7248:
                                CMP     #32
                                BCC     locret_724E
                                LDA     #31

locret_724E:
                                RTS
; End of function limit_asteroid_velocity


; =============== S U B R O U T I N E =======================================


display_C_scores_ships:
                                LDA     #16
                                STA     globalScale
.ifndef APPLE_IIGS                                
                                LDA     #$50 ; 'P'
                                LDX     #$A4 ; ''                              ; addr = 0x50A4
                                JSR     write_JSR_cmd                           ; "(C)1979 ATARI INC"
.else
                                ldy     #0
                                lda     #OP_COPYRIGHT
                                sta     (dvg_curr_addr_lsb),y
                                iny
                                sta     (dvg_curr_addr_lsb),y
                                jsr     update_dvg_curr_addr
.endif                                
                                LDA     #25                                     ; X coord (x4=100)
                                LDX     #219                                    ; Y coord (x4=876)
                                JSR     write_CURx4_cmd
                                LDA     #$70 ; 'p'                              ; scale = 7
                                JSR     set_scale_A_bright_0
                                LDX     #0                                      ; digit brightness += 0
                                LDA     numPlayers
                                CMP     #2                                      ; 2 players?
                                BNE     loc_7286                                ; no, skip
                                LDA     curPlayer                               ; player 1?
                                BNE     loc_7286                                ; yes, skip
                                LDX     #$20 ; ' '                              ; digit brightness += $20
                                LDA     ship_Sts
                                ORA     hyperspaceFlag
                                BNE     loc_7286
                                LDA     shipSpawnTimer
                                BMI     loc_7286
                                LDA     fastTimer
                                AND     #$10
                                BEQ     loc_7293                                ; not every frame

loc_7286:
                                LDA     #p1ScoreTens
                                LDY     #2                                      ; 2 bytes to display
                                SEC                                             ; flag no zero padding
                                JSR     display_numeric                         ; display P1 score
                                LDA     #0
                                JSR     display_bright_digit                    ; display score units (=0)

loc_7293:                                                                       ; X coord (x4=160)
                                LDA     #40
                                LDY     numShipsP1
                                JSR     display_extra_ships
                                LDA     #0
                                STA     globalScale
                                LDA     #120                                    ; X coord (x4=480)
                                LDX     #219                                    ; y coord (x4=876)
                                JSR     write_CURx4_cmd
                                LDA     #$50 ; 'P'                              ; scale = 5
                                JSR     set_scale_A_bright_0
                                LDA     #highScoreTable
                                LDY     #2                                      ; 2 bytes to display
                                SEC                                             ; flag no zero padding
                                JSR     display_numeric                         ; display high score
                                LDA     #0
                                JSR     display_digit_A                         ; display high score units (=0)
                                LDA     #$10
                                STA     globalScale
                                LDA     #192                                    ; X coord (x4=768)
                                LDX     #219                                    ; Y coord (x4=876)
                                JSR     write_CURx4_cmd
                                LDA     #$50 ; 'P'                              ; scale = 5
                                JSR     set_scale_A_bright_0
                                LDX     #0
                                LDA     numPlayers
                                CMP     #1                                      ; 1 player only?
                                BEQ     locret_72FD                             ; yes, exit
                                BCC     loc_72E9
                                LDA     curPlayer
                                BEQ     loc_72E9
                                LDX     #$20 ; ' '
                                LDA     ship_Sts
                                ORA     hyperspaceFlag
                                BNE     loc_72E9
                                LDA     shipSpawnTimer
                                BMI     loc_72E9
                                LDA     fastTimer
                                AND     #$10
                                BEQ     loc_72F6                                ; not every frame

loc_72E9:
                                LDA     #p2ScoreTens
                                LDY     #2                                      ; 2 bytes to display
                                SEC                                             ; flag no zero padding
                                JSR     display_numeric                         ; display P2 score
                                LDA     #0
                                JSR     display_bright_digit                    ; display score units (=0)

loc_72F6:                                                                       ; X coord (x4=828)
                                LDA     #207
                                LDY     numShipsP2
                                JMP     display_extra_ships
; ---------------------------------------------------------------------------

locret_72FD:
                                RTS
; End of function display_C_scores_ships

; Y=$E0/$F0/$00
; convert position from 13 bits (0-8191) to 10 bits (0-1023)
; - add a fudge-factor of 1024 (128 after scaling)

; =============== S U B R O U T I N E =======================================


display_object:
                                STY     globalScale
                                STX     byte_D                                  ; object offset (from P1RAM)
                                LDA     byte_5                                  ; object_PHh
                                LSR     A
                                ROR     byte_4                                  ; object_PLh
                                LSR     A
                                ROR     byte_4
                                LSR     A
                                ROR     byte_4
                                STA     byte_5                                  ; object_Ph /= 8
                                LDA     byte_7                                  ; object_PHv
                                CLC
                                ADC     #4
                                LSR     A
                                ROR     byte_6                                  ; object_PLv
                                LSR     A
                                ROR     byte_6
                                LSR     A
                                ROR     byte_6
                                STA     byte_7                                  ; object_PLv = (object_PLv+1024)/8
                                LDX     #4                                      ; base of temp coordinates
                                JSR     write_CUR_cmd
                                LDA     #$70 ; 'p'
                                SEC
                                SBC     globalScale
                                CMP     #$A0 ; ''
                                BCC     loc_733B

loc_732D:
                                PHA
                                LDA     #$90 ; ''
                                JSR     set_scale_A_bright_0
                                PLA
                                SEC
                                SBC     #$10
                                CMP     #$A0 ; ''
                                BCS     loc_732D

loc_733B:
                                JSR     set_scale_A_bright_0
                                LDX     byte_D                                  ; restore object offset
                                LDA     P1RAM,X                                 ; object status (again)
                                BPL     display_shot_ship_asteroid_or_saucer
                                CPX     #$1B                                    ; PlayerFlag?
                                BEQ     loc_7355                                ; yes, go
                                AND     #$C                                     ; status (3:2)
                                LSR     A                                       ; status (3:2)->(2:1)
.ifndef APPLE_IIGS                                
                                TAY                                             ; pattern = word offset
                                LDA     DVGROM+$F8,Y                            ; shrapnel table address LSB
                                LDX     DVGROM+$F9,Y                            ; shrapnel table address MSB
.else
                                ldy     #0
                                sta     (dvg_curr_addr_lsb),y
                                iny
                                lda     #OP_SHRAPNEL
                                sta     (dvg_curr_addr_lsb),y
                                jsr     update_dvg_curr_addr
.endif                                
                                BNE     loc_7370                                ; always

loc_7355:
                                JSR     display_exploding_ship
                                LDX     byte_D                                  ; restore object offset
                                RTS
; ---------------------------------------------------------------------------

display_shot_ship_asteroid_or_saucer:                                           ; PlayerFlag?
                                CPX     #$1B
                                BEQ     display_ship                            ; yes, go
                                CPX     #$1C                                    ; SaucerFlag?
                                BEQ     display_saucer                          ; yes, go
                                BCS     display_shot                            ; shot, go
                                AND     #$18                                    ; status (4:3)
                                LSR     A
                                LSR     A                                       ; status (4:3)->(2:1)
.ifndef APPLE_IIGS                                
                                TAY                                             ; = word offset
                                LDA     DVGROM+$1DE,Y                           ; asteroid table address LSB
                                LDX     DVGROM+$1DF,Y                           ; asteroid table address MSB

loc_7370:                                                                       ; writes JSR instruction
                                JSR     write_AX_to_avgram
.else
                                ldy     #0
                                sta     (dvg_curr_addr_lsb),y
                                iny
                                lda     #OP_ASTEROID
                                sta     (dvg_curr_addr_lsb),y
                                jsr     update_dvg_curr_addr
loc_7370:
.endif                                
                                LDX     byte_D                                  ; restore object offset
                                RTS
; ---------------------------------------------------------------------------

display_ship:
                                JSR     calc_ship_and_render
                                LDX     byte_D                                  ; restore object offset
                                RTS
; ---------------------------------------------------------------------------

display_saucer:                                                                 ; saucer table address LSB
.ifndef APPLE_IIGS
                                LDA     DVGROM+$250
                                LDX     DVGROM+$251                             ; saucer table address MSB
.else
                                ldy     #0
                                sta     (dvg_curr_addr_lsb),y										; saucer status
                                iny
                                lda     #OP_SAUCER
                                sta     (dvg_curr_addr_lsb),y
                                jsr     update_dvg_curr_addr
.endif                                
                                BNE     loc_7370                                ; always

display_shot:
.ifndef APPLE_IIGS
                                LDA     #$70 ; 'p'
                                LDX     #$F0 ; ''
                                JSR     set_scale_A_bright_X
.else
                                ldy     #0
                                sta     (dvg_curr_addr_lsb),y
                                iny
                                lda     #OP_SHOT
                                sta     (dvg_curr_addr_lsb),y
                                jsr     update_dvg_curr_addr
.endif                                
                                LDX     byte_D                                  ; restore object offset
                                LDA     fastTimer
                                AND     #3                                      ; time to dec?
                                BNE     locret_7396                             ; no, skip
                                DEC     P1RAM,X

locret_7396:
                                RTS
; End of function display_object


; =============== S U B R O U T I N E =======================================


add_A_to_score:
                                SED
                                ADC     p1ScoreTens,X
                                STA     p1ScoreTens,X
                                BCC     loc_73B0
                                LDA     p1ScoreThousands,X
                                ADC     #0
                                STA     p1ScoreThousands,X
                                AND     #$F                                     ; another 10,000?
                                BNE     loc_73B0                                ; no, skip
                                LDA     #$B0 ; ''
                                STA     timerBonusShipSound
                                LDX     curPlayer
                                INC     numShipsP1,X                            ; extra ship!

loc_73B0:
                                CLD
                                RTS
; End of function add_A_to_score


; =============== S U B R O U T I N E =======================================


set_RAMSEL_for_player:
                                LDA     curPlayer                               ; 0/1
                                ASL     A
                                ASL     A                                       ; 0/4
                                STA     byte_8
                                LDA     io3200ShadowRegister
                                AND     #$FB ; ''                              ; mask off RAMSEL
                                ORA     byte_8                                  ; OR in new RAMSEL
                                STA     io3200ShadowRegister
                                STA     $3200
                                RTS
; End of function set_RAMSEL_for_player


; =============== S U B R O U T I N E =======================================


display_high_score_table:
                                LDA     numPlayers                              ; game active?
                                BEQ     loc_73CA                                ; no, skip

loc_73C8:                                                                       ; flag game active
                                CLC
                                RTS
; ---------------------------------------------------------------------------

loc_73CA:
                                LDA     slowTimer
                                AND     #4
                                BNE     loc_73C8
                                LDA     highScoreTable
                                ORA     highScoreTable+1
                                BEQ     loc_73C8
                                LDY     #0                                      ; "HIGH SCORES"
                                JSR     PrintPackedMsg
                                LDX     #0
                                STX     initial_offset                          ; offset into initials
                                LDA     #1
                                STA     globalScale
                                LDA     #167                                    ; starting Y coord (x4=668)
                                STA     byte_E
                                LDA     #16
                                STA     globalScale

display_hs_entry:
                                LDA     highScoreTable,X
                                ORA     highScoreTable+1,X                      ; end of table?
                                BEQ     loc_7458                                ; yes, exit
                                STX     byte_F                                  ; entry counter (x2)
                                LDA     #95                                     ; x coord (x4=380)
                                LDX     byte_E                                  ; y coord
                                JSR     write_CURx4_cmd
                                LDA     #$40 ; '@'                              ; S=4
                                JSR     set_scale_A_bright_0
                                LDA     byte_F                                  ; entry counter (x2)
                                LSR     A                                       ; x1
                                SED
                                ADC     #1
                                CLD
                                STA     byte_D                                  ; number buffer for printing
                                LDA     #byte_D                                 ; ptr number buffer
                                SEC                                             ; flag no zero padding
                                LDY     #1                                      ; 1 byte to print
                                LDX     #0                                      ; pad digit
                                JSR     display_numeric                         ; display entry no.
.ifndef APPLE_IIGS
                                LDA     #$40 ; '@'                              ; S=4
                                TAX                                             ; Brightness=4
                                JSR     set_scale_A_bright_X                    ; displays a dot???
.else
; *** TBD display . character
.endif                                
                                LDY     #0                                      ; <space>
                                JSR     display_char_code_Y
                                LDA     byte_F                                  ; entry counter (x2)
                                CLC
                                ADC     #highScoreTable                         ; get ptr entry (score)
                                LDY     #2                                      ; 2 bytes to print
                                SEC                                             ; flag no zero padding
                                LDX     #0                                      ; pad digit
                                JSR     display_numeric                         ; display score
                                LDA     #0
                                JSR     display_digit_A
                                LDY     #0                                      ; <space>
                                JSR     display_char_code_Y
                                LDY     initial_offset                          ; get 1st initial
                                JSR     display_initial
                                INC     initial_offset
                                LDY     initial_offset                          ; get 2nd initial
                                JSR     display_initial
                                INC     initial_offset
                                LDY     initial_offset                          ; get 3rd initial
                                JSR     display_initial
                                INC     initial_offset
                                LDA     byte_E                                  ; y coord
                                SEC
                                SBC     #8                                      ; adjust for next line
                                STA     byte_E                                  ; update
                                LDX     byte_F                                  ; entry counter (x2)
                                INX
                                INX                                             ; +2
                                CPX     #20                                     ; done all 10 entries?
                                BCC     display_hs_entry                        ; no, loop

loc_7458:
                                SEC
                                RTS
; End of function display_high_score_table


; =============== S U B R O U T I N E =======================================


get_inactive_asteroid_cnt:
                                LDX     #26                                     ; 27 asteroids
; End of function get_inactive_asteroid_cnt


; =============== S U B R O U T I N E =======================================


get_inactive_object_cnt:
                                LDA     P1RAM,X                                 ; get object status
                                BEQ     locret_7464                             ; zero, exit
                                DEX                                             ; next object
                                BPL     get_inactive_object_cnt                 ; loop thru table

locret_7464:
                                RTS
; End of function get_inactive_object_cnt


; =============== S U B R O U T I N E =======================================


display_exploding_ship:
                                LDA     ship_Sts
.ifndef APPLE_IIGS                                
                                CMP     #$A2 ; ''                              ; 2 frames past exploding?
                                BCS     loc_748E
                                LDX     #10                                     ; 10 entries to parse

loc_746E:                                                                       ; start at RTS???
                                LDA     DVGROM+$EC,X
                                LSR     A
                                LSR     A
                                LSR     A
                                LSR     A                                       ; high->low nibble
                                CLC
                                ADC     #$F8 ; ''
                                EOR     #$F8 ; ''
                                STA     byte_7E,X
                                LDA     DVGROM+$ED,X
                                LSR     A
                                LSR     A
                                LSR     A
                                LSR     A                                       ; high->low nibble
                                CLC
                                ADC     #$F8 ; ''
                                EOR     #$F8 ; ''
                                STA     byte_80+$A,X
                                DEX
                                DEX
                                BPL     loc_746E

loc_748E:
                                LDA     ship_Sts
                                EOR     #$FF
                                AND     #$70 ; 'p'
                                LSR     A
                                LSR     A
                                LSR     A
                                TAX

loc_7499:
                                STX     byte_9
                                LDY     #0
                                LDA     DVGROM+$EC,X
                                BPL     loc_74A3
                                DEY

loc_74A3:
                                CLC
                                ADC     byte_7D,X
                                STA     byte_7D,X
                                TYA                                             ; 0/-1
                                ADC     byte_7E,X
                                STA     byte_7E,X
                                STA     byte_4
                                STY     byte_5
                                LDY     #0
                                LDA     DVGROM+$ED,X
                                BPL     loc_74B9
                                DEY

loc_74B9:
                                CLC
                                ADC     byte_80+9,X
                                STA     byte_80+9,X
                                TYA                                             ; 0/-1
                                ADC     byte_80+$A,X
                                STA     byte_80+$A,X
                                STA     byte_6
                                STY     byte_7
                                LDA     dvg_curr_addr_lsb
                                STA     byte_B
                                LDA     dvg_curr_addr_msb
                                STA     byte_C
                                JSR     from_exploding_ship
                                LDY     byte_9
                                LDA     DVGROM+$E0,Y                            ; wrecked ship table address LSB
                                LDX     DVGROM+$E1,Y                            ; wrecked ship table address MSB
                                JSR     write_AX_to_avgram
                                LDY     byte_9
                                LDA     DVGROM+$E1,Y                            ; wrecked ship table address MSB
                                EOR     #4
                                TAX
                                LDA     DVGROM+$E0,Y                            ; wrecked ship table address LSB
                                AND     #$F
                                EOR     #4
                                JSR     write_AX_to_avgram
                                LDY     #$FF

loc_74F1:
                                INY
                                LDA     (byte_B),Y
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                INY
                                LDA     (byte_B),Y
                                EOR     #4
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                CPY     #3
                                BCC     loc_74F1
                                JSR     update_dvg_curr_addr
                                LDX     byte_9
                                DEX
                                DEX
                                BPL     loc_7499
.else
                                ldy     #0
                                sta     (dvg_curr_addr_lsb),y                   ; ship_Sts
                                iny
                                lda     #OP_EXPLODINGSHIP
                                sta     (dvg_curr_addr_lsb),y
                                jsr     update_dvg_curr_addr
.endif                                
                                RTS
; End of function display_exploding_ship


; =============== S U B R O U T I N E =======================================


calc_ship_and_render:
                                LDX     #0                                      ; default positive delta
                                STX     extra_brightness
                                LDY     #0                                      ; default positive delta
                                LDA     direction
.ifndef APPLE_IIGS                                
                                BPL     loc_751B                                ; positive, skip
                                LDY     #4                                      ; flag negative delta
                                TXA                                             ; 0
                                SEC
                                SBC     direction

loc_751B:                                                                       ; ABS(direction)
                                STA     byte_8
                                BIT     byte_8
                                BMI     loc_7523                                ; b7=1
                                BVC     loc_752A                                ; b6=0

loc_7523:                                                                       ; flag negative delta
                                LDX     #4
                                LDA     #$80 ; ''
                                SEC
                                SBC     byte_8

loc_752A:                                                                       ; flag for flip X
                                STX     byte_8
                                STY     byte_9                                  ; flag for flip Y
                                LSR     A
                                AND     #$FE ; ''
                                TAY
                                LDA     DVGROM+$26E,Y                           ; ship table address LSB
                                LDX     DVGROM+$26F,Y                           ; ship table address MSB
                                JSR     copy_vector_list_from_table_to_dvgram
.else
                                sta     (dvg_curr_addr_lsb),y
                                iny
                                lda     #OP_SHIP
                                sta     (dvg_curr_addr_lsb),y
                                jsr     update_dvg_curr_addr
.endif                                
                                LDA     thrustSwitch                            ; thrust?
                                BPL     locret_7554                             ; no, exit
                                LDA     fastTimer
                                AND     #4                                      ; time to display thrust?
                                BEQ     locret_7554                             ; no, exit
.ifndef APPLE_IIGS                                
                                INY
                                INY                                             ; Y=2???
                                SEC
                                LDX     byte_C
                                TYA
                                ADC     byte_B
                                BCC     loc_7551
                                INX                                             ; BC+=2

loc_7551:
                                JSR     copy_vector_list_from_table_to_dvgram
.else
  ; render thrust
.endif                                

locret_7554:
                                RTS
; End of function calc_ship_and_render


; =============== S U B R O U T I N E =======================================


handle_sounds:
                                LDA     numPlayers                              ; game active?
                                BNE     update_sounds                           ; yes, update all sounds
                                RTS
; ---------------------------------------------------------------------------

update_sounds:
                                LDX     #0
                                LDA     saucer_Sts
                                BMI     loc_756B                                ; exploding, skip
                                BEQ     loc_756B                                ; no saucer, skip
                                ROR     A
                                ROR     A
                                ROR     A
                                STA     $3C02                                   ; sound select (large/small saucer)
                                LDX     #$80 ; ''                              ; enable sound

loc_756B:                                                                       ; sound (saucer)
                                STX     $3C00
                                LDX     #1                                      ; index to saucer fire sound
                                JSR     update_player_saucer_sound
                                STA     $3C01                                   ; sound (saucer fire)
                                DEX                                             ; index to player sound
                                JSR     update_player_saucer_sound
                                STA     $3C04                                   ; sound (ship fire)
                                LDA     ship_Sts
                                CMP     #1                                      ; alive?
                                BEQ     loc_7588                                ; yes, skip
                                TXA
                                STA     $3C03                                   ; sound (ship thrust)

loc_7588:
                                LDA     currentNumberOfAsteroids
                                BEQ     loc_759E
                                LDA     ship_Sts                                ; alive?
                                BMI     loc_759E                                ; no, skip
                                ORA     hyperspaceFlag                          ; hyperspace?
                                BEQ     loc_759E                                ; not active, skip
                                LDA     timerThumpSoundOn
                                BEQ     loc_75AE                                ; off, skip
                                DEC     timerThumpSoundOn                       ; update thump sound timer
                                BNE     loc_75BF                                ; not done, skip

loc_759E:
                                LDA     volFreqThumpSound
                                AND     #$F
                                STA     volFreqThumpSound
                                STA     $3A00                                   ; sound (thump)
                                LDA     starting_ThumpCounter
                                STA     timerThumpSoundOff
                                BPL     loc_75BF

loc_75AE:                                                                       ; update timer
                                DEC     timerThumpSoundOff
                                BNE     loc_75BF                                ; not done, skip
                                LDA     #4
                                STA     timerThumpSoundOn                       ; init thump on timer
                                LDA     volFreqThumpSound
                                EOR     #$14
                                STA     volFreqThumpSound
                                STA     $3A00                                   ; sound (thump)

loc_75BF:
                                LDA     timerExplosionSound
                                TAX
                                AND     #$3F ; '?'                              ; exploding sound on?
                                BEQ     loc_75C7                                ; no, skip
                                DEX                                             ; update timer

loc_75C7:
                                STX     timerExplosionSound
                                STX     $3600                                   ; sound (explosion)
                                RTS
; End of function handle_sounds


; =============== S U B R O U T I N E =======================================


update_player_saucer_sound:
                                LDA     fireSoundFlagPlayer,X                   ; player/saucer sound flag
                                BMI     loc_75DD                                ; branch if ON
                                LDA     timerPlayerFireSound,X                  ; player/saucer fire sound timer
                                BPL     loc_75E7
                                LDA     #$10                                    ; init value
                                STA     timerPlayerFireSound,X                  ; player/saucer fire sound timer

loc_75D9:                                                                       ; turn on sound
                                LDA     #$80 ; ''
                                BMI     loc_75E9                                ; exit

loc_75DD:                                                                       ; player/saucer fire sound timer
                                LDA     timerPlayerFireSound,X
                                BEQ     loc_75E7                                ; done, turn off
                                BMI     loc_75E7                                ; done, turn off
                                DEC     timerPlayerFireSound,X                  ; dec timer
                                BNE     loc_75D9                                ; not done, turn on

loc_75E7:                                                                       ; turn off sound
                                LDA     #0

loc_75E9:                                                                       ; player/saucer sound flag
                                STA     fireSoundFlagPlayer,X
                                RTS
; End of function update_player_saucer_sound

; X=offset to object that hit asteroid, Y=offset to asteroid
; - potentially adds 2 more asteroids to the table
;   but note that the original asteroid object entry remains

; =============== S U B R O U T I N E =======================================


handle_asteroid_hit:
                                STX     byte_D                                  ; save object index
                                LDA     #80
                                STA     asteroid_hit_timer
                                LDA     P1RAM,Y                                 ; asteroid status
                                AND     #$78 ; 'x'                              ; bits 6-3 only
                                STA     byte_E
                                LDA     P1RAM,Y                                 ; asteroid status
                                AND     #7                                      ; bits 2-0 only
                                LSR     A                                       ; next size down
                                TAX                                             ; asteroid size
                                BEQ     loc_7605                                ; small, skip
                                ORA     byte_E

loc_7605:                                                                       ; update asteroid status
                                STA     P1RAM,Y
                                LDA     numPlayers                              ; real game?
                                BEQ     handle_asteroid_split                   ; no, skip
                                LDA     byte_D                                  ; object index
                                BEQ     add_asteroid_score                      ; ship!
                                CMP     #4                                      ; player shot?
                                BCC     handle_asteroid_split                   ; no, skip score

add_asteroid_score:                                                             ; score for this asteroid
                                LDA     asteroid_score_tbl,X
                                LDX     curPlayer_x2                            ; offset to score for player
                                CLC
                                JSR     add_A_to_score                          ; add asteroid score

handle_asteroid_split:                                                          ; asteroid status
                                LDX     P1RAM,Y
                                BEQ     loc_7656                                ; small, no split, exit
                                JSR     get_inactive_asteroid_cnt               ; X = empty slot
                                BMI     loc_7656                                ; no slots, exit
                                INC     currentNumberOfAsteroids                ; add another asteroid
                                JSR     clone_asteroid_rnd_shape
                                JSR     set_asteroid_velocity
                                LDA     asteroid_Vh,X
                                AND     #$1F
                                ASL     A                                       ; twice as fast
                                EOR     asteroid_PLh,X
                                STA     asteroid_PLh,X
                                JSR     get_inactive_object_cnt                 ; any slots left?
                                BMI     loc_7656                                ; no, exit
                                INC     currentNumberOfAsteroids                ; add another asteroid
                                JSR     clone_asteroid_rnd_shape
                                JSR     set_asteroid_velocity
                                LDA     asteroid_Vv,X
                                AND     #$1F
                                ASL     A                                       ; twice as fast
                                EOR     asteroid_PLv,X
                                STA     asteroid_PLv,X

loc_7656:                                                                       ; restore object index
                                LDX     byte_D
                                RTS
; End of function handle_asteroid_hit

; ---------------------------------------------------------------------------
asteroid_score_tbl:             .BYTE $10                                       ; 100pts (small asteroid)
                                .BYTE   5                                       ; 50pts (medium asteroid)
                                .BYTE   2                                       ; 20pts (large asteroid)

; =============== S U B R O U T I N E =======================================


check_high_score:
                                LDA     numPlayers                              ; game active?
                                BPL     locret_7698                             ; yes, skip
                                LDX     #2                                      ; 2 players to check
                                STA     slowTimer
                                STA     placeP1HighScore
                                STA     placeP2HighScore

loc_7668:
                                LDY     #0

loc_766A:
                                LDA     highScoreTable,Y
                                CMP     p1ScoreTens,X
                                LDA     highScoreTable+1,Y
                                SBC     p1ScoreThousands,X
                                BCC     insert_score_in_table                   ; high score here, exit
                                INY
                                INY                                             ; next high score entry
                                CPY     #20                                     ; done all 10 entries (20 bytes)?
                                BCC     loc_766A                                ; no, loop

loc_767C:
                                DEX
                                DEX                                             ; set to player 1
                                BPL     loc_7668                                ; loop for player 1
                                LDA     placeP2HighScore
                                BMI     loc_7692
                                CMP     placeP1HighScore
                                BCC     loc_7692
                                ADC     #2
                                CMP     #30
                                BCC     loc_7690
                                LDA     #$FF

loc_7690:
                                STA     placeP2HighScore

loc_7692:
                                LDA     #0
                                STA     numPlayers                              ; flag game over
                                STA     letterHighScoreEntry

locret_7698:
                                RTS
; ---------------------------------------------------------------------------

insert_score_in_table:                                                          ; player 1/2
                                STX     byte_B
                                STY     byte_C                                  ; high score entry offset
                                TXA
                                LSR     A                                       ; 0=p1, 1=p2
                                TAX
                                TYA
                                LSR     A                                       ; high score entry index
                                ADC     byte_C                                  ; high score index * 3
                                STA     byte_D                                  ; offset into initials table?
                                STA     placeP1HighScore,X
                                LDX     #27                                     ; offset of 10th initials
                                LDY     #18

loc_76AC:                                                                       ; entry we're after?
                                CPX     byte_D
                                BEQ     loc_76CF                                ; yes, exit
                                LDA     letterHighScoreEntry,X
                                STA     highScoreInitials,X
                                LDA     placeP1HighScore,X
                                STA     highScoreInitials+1,X
                                LDA     placeP2HighScore,X
                                STA     highScoreInitials+2,X
                                LDA     byte_1B,Y
                                STA     highScoreTable,Y
                                LDA     numPlayers,Y
                                STA     highScoreTable+1,Y                      ; shift entry down
                                DEY
                                DEY                                             ; next high score entry
                                DEX
                                DEX
                                DEX                                             ; next initials entry
                                BNE     loc_76AC                                ; not done, loop

loc_76CF:                                                                       ; 'A'
                                LDA     #$B
                                STA     highScoreInitials,X
                                LDA     #0
                                STA     highScoreInitials+1,X
                                STA     highScoreInitials+2,X
                                LDA     #$F0 ; ''
                                STA     slowTimer
                                LDX     byte_B                                  ; player 1/2
                                LDY     byte_C                                  ; high score entry offset
                                LDA     p1ScoreThousands,X
                                STA     highScoreTable+1,Y
                                LDA     p1ScoreTens,X
                                STA     highScoreTable,Y                        ; copy score into high score table
                                LDY     #0
                                BEQ     loc_767C                                ; continue with next entry
; End of function check_high_score

; ---------------------------------------------------------------------------
                                .BYTE $DF
; ---------------------------------------------------------------------------

loc_76F0:
                                TYA
                                BPL     loc_76FC
                                JSR     negate_A
                                JSR     loc_76FC
                                JMP     negate_A
; ---------------------------------------------------------------------------

loc_76FC:
                                TAY
                                TXA
                                BPL     sub_770E
                                JSR     negate_A
                                JSR     sub_770E
                                EOR     #$80 ; ''

; =============== S U B R O U T I N E =======================================


negate_A:
                                EOR     #$FF
                                CLC
                                ADC     #1
                                RTS
; End of function negate_A


; =============== S U B R O U T I N E =======================================


sub_770E:
                                STA     byte_C
                                TYA
                                CMP     byte_C
                                BEQ     loc_7725
                                BCC     sub_7728
                                LDY     byte_C
                                STA     byte_C
                                TYA
                                JSR     sub_7728
                                SEC
                                SBC     #$40 ; '@'
                                JMP     negate_A
; ---------------------------------------------------------------------------

loc_7725:
                                LDA     #$20 ; ' '
                                RTS
; End of function sub_770E


; =============== S U B R O U T I N E =======================================


sub_7728:
                                JSR     sub_776C
                                LDA     unk_772F,X
                                RTS
; End of function sub_7728

; ---------------------------------------------------------------------------
unk_772F:                       .BYTE   0
                                .BYTE   2
                                .BYTE   5
                                .BYTE   7
                                .BYTE  $A
                                .BYTE  $C
                                .BYTE  $F
                                .BYTE $11
                                .BYTE $13
                                .BYTE $15
                                .BYTE $17
                                .BYTE $19
                                .BYTE $1A
                                .BYTE $1C
                                .BYTE $1D
                                .BYTE $1F
; A=buffer, Y=#bytes

; =============== S U B R O U T I N E =======================================


display_numeric:
                                PHP
                                STX     extra_brightness                        ; save extra brightness
                                DEY                                             ; #bytes-1
                                STY     byte_16                                 ; offset to last byte
                                CLC
                                ADC     byte_16                                 ; buf + #bytes-1
                                STA     byte_15                                 ; ptr current byte
                                PLP
                                TAX                                             ; X=buffer

loc_774C:
                                PHP
                                LDA     0,X                                     ; get next byte
                                LSR     A
                                LSR     A
                                LSR     A
                                LSR     A                                       ; high nibble -> low
                                PLP
                                JSR     display_digit
                                LDA     byte_16                                 ; bytes remaining?
                                BNE     loc_775C                                ; no, skip
                                CLC                                             ; flag padding

loc_775C:                                                                       ; ptr current byte
                                LDX     byte_15
                                LDA     0,X                                     ; get byte (low nibble)
                                JSR     display_digit
                                DEC     byte_15                                 ; ptr current byte
                                LDX     byte_15
                                DEC     byte_16                                 ; done?
                                BPL     loc_774C                                ; no, loop
                                RTS
; End of function display_numeric


; =============== S U B R O U T I N E =======================================


sub_776C:
                                LDY     #0
                                STY     byte_B
                                LDY     #4

loc_7772:
                                ROL     byte_B
                                ROL     A
                                CMP     byte_C
                                BCC     loc_777B
                                SBC     byte_C

loc_777B:
                                DEY
                                BNE     loc_7772
                                LDA     byte_B
                                ROL     A
                                AND     #$F
                                TAX
                                RTS
; End of function sub_776C


; =============== S U B R O U T I N E =======================================


display_digit:
                                BCC     display_bright_digit                    ; skip if no pad flagged?
                                AND     #$F                                     ; any pad digit?
                                BEQ     loc_77B2                                ; no, skip
; End of function display_digit


; =============== S U B R O U T I N E =======================================


display_bright_digit:
                                LDX     extra_brightness                        ; extra brightness?
                                BEQ     loc_77B2                                ; none, use default routine
                                AND     #$F
                                CLC
                                ADC     #1
                                PHP
                                ASL     A                                       ; x2
.ifndef APPLE_IIGS                                
                                TAY                                             ; word offset
                                LDA     DVGROM+$6D4,Y                           ; chr fn
                                ASL     A                                       ; low address * 2
                                STA     byte_B
                                LDA     DVGROM+$6D5,Y                           ; chr fn
                                ROL     A
                                AND     #$1F                                    ; high address * 2
                                ORA     #$40 ; '@'                              ; +0x4000
                                STA     byte_C
                                LDA     #0
                                STA     byte_8                                  ; flag to flip X
                                STA     byte_9                                  ; flag to flip Y
                                JSR     copy_vector_list_to_avgram
.else
                                ldy     #0
                                sta     (dvg_curr_addr_lsb),y
                                iny
                                lda     #OP_CHR
                                sta     (dvg_curr_addr_lsb),y
                                jsr     update_dvg_curr_addr
.endif
                                PLP
                                RTS
; ---------------------------------------------------------------------------

loc_77B2:
                                JMP     display_space_digit_A
; End of function display_bright_digit

; this is a 16-bit 1-tap LFSR
; - may or may not be maximal length
;   has check for zero

; =============== S U B R O U T I N E =======================================


update_prng:
                                ASL     rnd1
                                ROL     rnd2                                    ; shift left 16-bit value
                                BPL     loc_77BD                                ; no shift out
                                INC     rnd1                                    ; shift into low bit

loc_77BD:
                                LDA     rnd1
                                BIT     tap                                     ; tap on output of bit0
                                BEQ     loc_77C8                                ; not set, skip
                                EOR     #1                                      ; XOR bit0
                                STA     rnd1

loc_77C8:                                                                       ; check all 0
                                ORA     rnd2
                                BNE     loc_77CE                                ; no, skip
                                INC     rnd1                                    ; =1

loc_77CE:                                                                       ; return low byte
                                LDA     rnd1
                                RTS
; End of function update_prng

; ---------------------------------------------------------------------------
tap:                            .BYTE 2
; A=direction, Y=offset to shot timer

; =============== S U B R O U T I N E =======================================


get_thrust_cos:
                                CLC
                                ADC     #64                                     ; (0-127)=up, (128-255)=down
; End of function get_thrust_cos


; =============== S U B R O U T I N E =======================================


get_thrust_sin:
                                BPL     sub_77DF                                ; up? go
                                AND     #$7F ; ''                              ; mask off up/down
                                JSR     sub_77DF
                                JMP     negate_A
; End of function get_thrust_sin


; =============== S U B R O U T I N E =======================================


sub_77DF:
                                CMP     #65                                     ; left/right?
                                BCC     loc_77E7                                ; right, go
                                EOR     #$7F ; ''                              ; toggle up/down
                                ADC     #0

loc_77E7:
                                TAX
                                LDA     DVGROM+$7B9,X                           ; sine table
                                RTS
; End of function sub_77DF

; ---------------------------------------------------------------------------
                                .BYTE   0
                                .BYTE   0
                                .BYTE   0
                                .BYTE   0
                                .BYTE   0
                                .BYTE   0
                                .BYTE   0
                                .BYTE   0
                                .BYTE   0
                                .BYTE   0
; Y=message number
; 0=English, 1=German, 2=French, 3=Spanish


; =============== S U B R O U T I N E =======================================


PrintPackedMsg:
                                LDA     language
                                AND     #3                                      ; mask off invalid bits
                                ASL     A                                       ; convert to word offset
                                TAX
                                LDA     #$10
                                STA     globalScale
                                LDA     msgTablePtrs+1,X
                                STA     byte_9
                                LDA     msgTablePtrs,X
                                STA     byte_8                                  ; for this language
                                ADC     (8),Y                                   ; add message number
                                STA     byte_8                                  ; update offset
                                BCC     loc_7813                                ; no overflow, skip
                                INC     byte_9                                  ; adjust high byte

loc_7813:                                                                       ; message number
                                TYA
                                ASL     A                                       ; convert to word offset
                                TAY
                                LDA     msgCoords,Y                             ; X
                                LDX     msgCoords+1,Y                           ; Y
                                JSR     write_CURx4_cmd
                                LDA     #$70 ; 'p'
                                JSR     set_scale_A_bright_0
                                LDY     #0
                                LDX     #0

loc_7828:                                                                       ; get message byte
                                LDA     (8,X)
                                STA     byte_B                                  ; temp store
                                LSR     A                                       ; X,7-1
                                LSR     A                                       ; XX,7-2 (XX76543X)
                                JSR     inc_msg_ptr_add_chr_fn
                                LDA     (8,X)                                   ; get next message byte
                                ROL     A                                       ; 7->C
                                ROL     byte_B                                  ; 6-0,7
                                ROL     A                                       ; 6->C
                                LDA     byte_B                                  ; 6-0,7
                                ROL     A                                       ; 5-0,7,6
                                ASL     A                                       ; 4-0,7,6,5 (XX21076X)
                                JSR     add_chr_fn
                                LDA     (8,X)                                   ; get same message byte again
                                STA     byte_B                                  ; temp store (XX54321X)
                                JSR     inc_msg_ptr_add_chr_fn
                                LSR     byte_B                                  ; end of message?
                                BCC     loc_7828                                ; no, loop

loc_7849:
                                DEY
                                JMP     update_dvg_curr_addr
; End of function PrintPackedMsg


; =============== S U B R O U T I N E =======================================


inc_msg_ptr_add_chr_fn:
                                INC     byte_8                                  ; inc msg ptr
                                BNE     add_chr_fn                              ; no overflow, skip
                                INC     byte_9                                  ; inc msg ptr msb
; End of function inc_msg_ptr_add_chr_fn


; =============== S U B R O U T I N E =======================================


add_chr_fn:
                                AND     #$3E ; '>'                              ; get character (bits 5-1)
                                BNE     loc_785B                                ; if not space, skip
                                PLA
                                PLA                                             ; pop return address
                                BNE     loc_7849                                ; return, finishing byte pair (3 chars)

loc_785B:                                                                       ; numeric?
                                CMP     #$A
                                BCC     loc_7861                                ; yes, skip
                                ADC     #$D

loc_7861:                                                                       ; X = chr*2 (chr fn offset)
.ifndef APPLE_IIGS
                                TAX
                                LDA     DVGROM+$6D2,X                           ; chr fn msb
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                INY
                                LDA     DVGROM+$6D3,X                           ; chr fn lsb
.else
                                sec                                             ; no borrow
                                sbc     #2                                      ; $6D2 vs $6D4!
                                sta     (dvg_curr_addr_lsb),y
                                iny
                                lda     #OP_CHR
.endif                                
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                INY
                                LDX     #0
                                RTS
; End of function add_chr_fn

; ---------------------------------------------------------------------------
msgCoords:                      .BYTE 100, 182                                  ; "HIGH SCORES"
                                .BYTE 100, 182                                  ; "PLAYER"
                                .BYTE 12, 170                                   ; "YOUR SCORE...TEN BEST"
.ifndef APPLE_IIGS
                                .BYTE 12, 162                                   ; "PLEASE...INITIALS"
                                .BYTE 12, 154                                   ; "PUSH ROTATE...LETTER"
                                .BYTE 12, 146                                   ; "PUSH HYPERSPACE...CORRECT"
.else
                                .BYTE 12, 162-4                                   ; "PLEASE...INITIALS"
                                .BYTE 12, 154-8                                   ; "PUSH ROTATE...LETTER"
                                .BYTE 12, 146-12                                   ; "PUSH HYPERSPACE...CORRECT"
.endif                                
                                .BYTE 100, 198                                  ; "PUSH START"
                                .BYTE 100, 157                                  ; "GAME OVER"
                                .BYTE 80, 57                                    ; "1 COIN 2 PLAYS"
                                .BYTE 80, 57                                    ; "1 COIN 1 PLAY"
                                .BYTE 80, 57                                    ; "2 COINS 1 PLAY"
; Offset into Vector ROM for message tables
msgTablePtrs:                   .WORD $571E                                     ; English
                                .WORD $788F                                     ; German
                                .WORD $7946                                     ; French
                                .WORD $79F3                                     ; Spanish
; German
; - offsets
                                .BYTE $B, $15, $1B, $35, $4D, $65, $7F, $8D, $93, $9F, $AB
; - messages
                                .BYTE $64, $D2, $3B, $2E, $C2, $6C, $5A, $4C, $93, $6F, $BD, $1A, $4C, $12, $B0, $40, $6B, $2C, $A, $6C
                                .BYTE $5A, $4C, $93, $6E, $B, $6E, $C0, $52, $6C, $92, $B8, $50, $4D, $82, $F2, $58, $90, $4C, $4D, $F0
                                .BYTE $4C, $80, $33, $70, $C2, $42, $5A, $4C, $4C, $82, $BB, $52, $B, $58, $B2, $42, $6C, $9A, $C3, $4A
                                .BYTE $82, $64, $A, $5A, $90, 0, $F6, $6C, 9, $B2, $3B, $2E, $C1, $4C, $4C, $B6, $2B, $20, $D, $A6, $C1
                                .BYTE $70, $48, $50, $B6, $52, $3B, $D2, $90, 0, $DA, $64, $90, $4C, $C9, $D8, $BE, $A, $32, $42, $9B
                                .BYTE $C2, $67, $68, $4D, $AE, $A1, $4E, $48, $50, $B6, $52, $3B, $D2, $90, 0, $BE, $A, $B6, $1E, $94
                                .BYTE $D2, $A2, $92, $A, $2C, $CA, $4E, $7A, $65, $BD, $1A, $4C, $12, $92, $13, $18, $62, $CA, $64, $F2
                                .BYTE $42, $20, $6E, $A3, $52, $82, $40, $18, $62, $CA, $64, $F2, $42, $18, $6E, $A3, $52, $80, 0, $20
                                .BYTE $62, $CA, $64, $F2, $64, 8, $C2, $BD, $1A, $4C, 0
; French
; - offsets
                                .BYTE $B, $15, $19, $31, $41, $57, $73, $7F, $89, $95, $A1
; - messages
                                .BYTE $8A, $5A, $84, $12, $CD, $82, $B9, $E6, $B2, $40, $74, $F2, $4D, $83, $D4, $F0, $B2, $42, $B9
                                .BYTE $E6, $B2, $42, $4D, $F0, $E, $64, $A, $12, $B8, $46, $10, $62, $4B, $60, $82, $72, $B5, $C0, $BE
                                .BYTE $A8, $A, $64, $C5, $92, $F0, $74, $9D, $C2, $6C, $9A, $C3, $4A, $82, $6F, $A4, $F2, $BD, $D2, $F0
                                .BYTE $6C, $9E, $A, $C2, $42, $A4, $F2, $B0, $74, $9D, $C2, $6C, $9A, $C3, $4A, $82, $6F, $A4, $F2, $BD
                                .BYTE $D2, $F0, $58, $ED, $12, $B5, $E8, $29, $D2, $D, $72, $2C, $90, $C, $12, $C6, $2C, $48, $4E, $9D
                                .BYTE $AC, $49, $F0, $48, 0, $2D, $28, $CF, $52, $B0, $6E, $CD, $82, $BE, $A, $B6, 0, $53, $64, $A, $12
                                .BYTE $D, $A, $B6, $1A, $48, 0, $18, $68, $6A, $4E, $48, $48, $B, $A6, $CA, $72, $B5, $C0, $18, $68
                                .BYTE $6A, $4E, $48, $46, $B, $A6, $CA, $72, $B0, 0, $20, $68, $6A, $4E, $4D, $C2, $18, $5C, $9E, $52
                                .BYTE $CD, $80
; Spanish
; - offsets
                                .BYTE $B, $11, $17, $31, $45, $5F, $6B, $73, $7D, $89, $93
; - messages
                                .BYTE $B2, $4E, $9D, $90, $B8, 0, $76, $56, $2A, $26, $B0, $40, $BE, $42, $A6, $64, $C1, $5C, $48, $52
                                .BYTE $BE, $A, $A, $64, $C5, $92, $C, $26, $B8, $50, $6A, $7C, $C, $52, $74, $EC, $4D, $C0, $A4, $EC
                                .BYTE $A, $8A, $D4, $EC, $A, $64, $C5, $92, $D, $F2, $B8, $5A, $93, $4E, $69, $60, $4D, $C0, $9D, $2C
                                .BYTE $6C, $4A, $D, $A6, $C1, $70, $48, $68, $2D, $8A, $D, $D2, $82, $4E, $3B, $66, $91, $6C, $C, $A
                                .BYTE $C, $12, $C5, $8B, $9D, $2C, $6C, $4A, $B, $3A, $A2, $6C, $BD, $A, $3A, $40, $A6, $60, $B9, $6C
                                .BYTE $D, $F0, $2D, $B1, $76, $52, $5C, $C2, $C2, $6C, $8B, $64, $2A, $27, $18, $54, $69, $D8, $28, $48
                                .BYTE $B, $B2, $4A, $E6, $B8, 0, $18, $54, $69, $D8, $28, $46, $B, $B2, $4A, $E7, $20, $54, $69, $D8
                                .BYTE $2D, $C2, $18, $5C, $CA, $56, $98, 0, $52

; =============== S U B R O U T I N E =======================================


handle_coin_switches:
                                LDX     #2

loc_7A95:                                                                       ; read coinswitch
                                LDA     leftCoinSwitch,X
                                ASL     A
                                LDA     coin_1_inp_length,X
                                AND     #$1F
                                BCC     loc_7AD6
                                BEQ     loc_7AB1
                                CMP     #$1B
                                BCS     loc_7AAF
                                TAY
                                LDA     NMI_count
                                AND     #7
                                CMP     #7
                                TYA
                                BCC     loc_7AB1

loc_7AAF:
                                SBC     #1

loc_7AB1:
                                STA     coin_1_inp_length,X
                                LDA     slamSwitch
                                AND     #$80 ; ''
                                BEQ     loc_7ABE
                                LDA     #$F0 ; ''
                                STA     slamSwitchFlag

loc_7ABE:
                                LDA     slamSwitchFlag
                                BEQ     loc_7ACA
                                DEC     slamSwitchFlag
                                LDA     #0
                                STA     coin_1_inp_length,X
                                STA     byte_77,X

loc_7ACA:
                                CLC
                                LDA     byte_77,X
                                BEQ     loc_7AF2
                                DEC     byte_77,X
                                BNE     loc_7AF2
                                SEC
                                BCS     loc_7AF2

loc_7AD6:
                                CMP     #$1B
                                BCS     loc_7AE3
                                LDA     coin_1_inp_length,X
                                ADC     #$20 ; ' '
                                BCC     loc_7AB1
                                BEQ     loc_7AE3
                                CLC

loc_7AE3:
                                LDA     #$1F
                                BCS     loc_7AB1
                                STA     coin_1_inp_length,X
                                LDA     byte_77,X
                                BEQ     loc_7AEE
                                SEC

loc_7AEE:
                                LDA     #$78 ; 'x'
                                STA     byte_77,X

loc_7AF2:
                                BCC     loc_7B17
                                LDA     #0
                                CPX     #1
                                BCC     loc_7B10
                                BEQ     loc_7B08
                                LDA     coinMultCredits
                                AND     #$C
                                LSR     A
                                LSR     A
                                BEQ     loc_7B10
                                ADC     #2
                                BNE     loc_7B10

loc_7B08:
                                LDA     coinMultCredits
                                AND     #$10
                                BEQ     loc_7B10
                                LDA     #1

loc_7B10:
                                SEC
                                ADC     totalCoinsForCredits
                                STA     totalCoinsForCredits
                                INC     byte_74,X

loc_7B17:
                                DEX
                                BMI     loc_7B1D
                                JMP     loc_7A95                                ; next coin switch
; ---------------------------------------------------------------------------

loc_7B1D:
                                LDA     coinMultCredits
                                AND     #3
                                TAY
                                BEQ     loc_7B36
                                LSR     A
                                ADC     #0
                                EOR     #$FF
                                SEC
                                ADC     totalCoinsForCredits
                                BCC     loc_7B38
                                CPY     #2
                                BCS     loc_7B34
                                INC     CurrNumCredits

loc_7B34:
                                INC     CurrNumCredits

loc_7B36:
                                STA     totalCoinsForCredits

loc_7B38:
                                LDA     NMI_count
                                LSR     A
                                BCS     locret_7B64
                                LDY     #0
                                LDX     #2

loc_7B41:
                                LDA     byte_74,X
                                BEQ     loc_7B4E
                                CMP     #$10
                                BCC     loc_7B4E
                                ADC     #$EF ; ''
                                INY
                                STA     byte_74,X

loc_7B4E:
                                DEX
                                BPL     loc_7B41
                                TYA
                                BNE     locret_7B64
                                LDX     #2

loc_7B56:
                                LDA     byte_74,X
                                BEQ     loc_7B61
                                CLC
                                ADC     #$EF ; ''
                                STA     byte_74,X
                                BMI     locret_7B64

loc_7B61:
                                DEX
                                BPL     loc_7B56

locret_7B64:
                                RTS
; End of function handle_coin_switches

; ---------------------------------------------------------------------------
; NMI: 250Hz interrupt

NMI:
                                PHA
                                TYA
                                PHA
                                TXA
                                PHA
                                CLD
                                LDA     stack+$FF
                                ORA     stack+$D0                               ; check stack guard bytes

loc_7B71:                                                                       ; stack overflow - loop
                                BNE     loc_7B71
                                INC     NMI_count
                                LDA     NMI_count
                                AND     #3                                      ; every 4th NMI - 62.5Hz (roughly VBLANK)
                                BNE     loc_7B83                                ; no, skip
                                INC     VBLANK_triggered
                                LDA     VBLANK_triggered
                                CMP     #4                                      ; reached 4?

loc_7B81:                                                                       ; yes, spin (hang)
                                BCS     loc_7B81

loc_7B83:
                                JSR     handle_coin_switches
                                LDA     io3200ShadowRegister
                                AND     #$C7 ; ''
                                BIT     byte_74
                                BPL     loc_7B90
                                ORA     #8                                      ; left coin counter

loc_7B90:
                                BIT     byte_75
                                BPL     loc_7B96
                                ORA     #$10                                    ; centre coin counter

loc_7B96:
                                BIT     byte_76
                                BPL     loc_7B9C
                                ORA     #$20 ; ' '                              ; right coin counter

loc_7B9C:
                                STA     io3200ShadowRegister
                                STA     $3200                                   ; output
                                LDA     slamSwitchFlag
                                BEQ     loc_7BA9
                                LDA     #$80 ; ''
                                BNE     loc_7BB7

loc_7BA9:
                                LDA     timerBonusShipSound
                                BEQ     loc_7BB7
                                LDA     fastTimer
                                ROR     A
                                BCC     loc_7BB4
                                DEC     timerBonusShipSound

loc_7BB4:
                                ROR     A
                                ROR     A
                                ROR     A

loc_7BB7:                                                                       ; sound (bonus life)
                                STA     $3C05
                                PLA
                                TAX
                                PLA
                                TAY
                                PLA
                                RTI

; =============== S U B R O U T I N E =======================================


halt_dvg:
.ifndef APPLE_IIGS
                                LDA     #$B0 ; ''
.else
                                lda     #OP_HALT
.endif
                                LDY     #0
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                INY
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                BNE     update_dvg_curr_addr

display_space_digit_A:
                                BCC     display_digit_A
                                AND     #$F                                     ; numeric only
                                BEQ     loc_7BD6                                ; space, skip
; End of function halt_dvg

; A = character

; =============== S U B R O U T I N E =======================================


display_digit_A:
                                AND     #$F                                     ; numeric only
                                CLC
                                ADC     #1                                      ; convert to char code

loc_7BD6:
                                PHP
                                ASL     A                                       ; x2 (word offset)
                                LDY     #0
.ifndef APPLE_IIGS
                                TAX
                                LDA     DVGROM+$6D4,X                           ; chr fn msb
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                LDA     DVGROM+$6D5,X                           ; chr fn lsb
.else
                                sta     (dvg_curr_addr_lsb),y
                                lda     #OP_CHR
.endif                                
                                INY
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                JSR     update_dvg_curr_addr
                                PLP
                                RTS
; End of function display_digit_A

; ---------------------------------------------------------------------------
                                LSR     A                                       ; adjust address
                                AND     #$F                                     ; clear cmd nibble
                                ORA     #$E0 ; ''                              ; JMP command
; START OF FUNCTION CHUNK FOR write_JSR_cmd

write_JMP_JSR_cmd:
                                LDY     #1
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                DEY
                                TXA
                                ROR     A                                       ; adjust address
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                INY
                                BNE     update_dvg_curr_addr
; END OF FUNCTION CHUNK FOR write_JSR_cmd
; A:X = address

; =============== S U B R O U T I N E =======================================


write_JSR_cmd:

; FUNCTION CHUNK AT 7BF0 SIZE 0000000C BYTES

                                LSR     A                                       ; adjust address
                                AND     #$F                                     ; clear cmd nibble
                                ORA     #$C0 ; ''                              ; JSR command
                                BNE     write_JMP_JSR_cmd
; End of function write_JSR_cmd

; A=X coord, X=Y coord

; =============== S U B R O U T I N E =======================================


write_CURx4_cmd:
                                LDY     #0
                                STY     byte_5
                                STY     byte_7
                                ASL     A
                                ROL     byte_5
                                ASL     A
                                ROL     byte_5                                  ; X*4 (msb)
                                STA     byte_4                                  ; X*4 (lsb)
                                TXA
                                ASL     A
                                ROL     byte_7
                                ASL     A
                                ROL     byte_7                                  ; Y*4 (msb)
                                STA     byte_6                                  ; Y*4 (lsb)
                                LDX     #4
; End of function write_CURx4_cmd


; =============== S U B R O U T I N E =======================================


write_CUR_cmd:
                                LDA     2,X                                     ; @$6 = Y*4 (lsb)
                                LDY     #0
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                LDA     3,X                                     ; @$7 = Y*4 (msb)
                                AND     #$F                                     ; clear command nibble
.ifndef APPLE_IIGS                                
                                ORA     #$A0 ; ''                              ; CUR command
.else
                                ora     #OP_CUR
.endif
                                INY
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                LDA     0,X                                     ; @$4 = X*4 (lsb)
                                INY
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                LDA     1,X                                     ; @$5 = X*4 (msb)
                                AND     #$F                                     ; clear scale nibble
                                ORA     globalScale                             ; global scale
                                INY
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
; End of function write_CUR_cmd


; =============== S U B R O U T I N E =======================================


update_dvg_curr_addr:
                                TYA                                             ; #bytes this operation
                                SEC
                                ADC     dvg_curr_addr_lsb
                                STA     dvg_curr_addr_lsb
                                BCC     locret_7C43                             ; no overflow, skip
                                INC     dvg_curr_addr_msb

locret_7C43:
                                RTS
; End of function update_dvg_curr_addr

; ---------------------------------------------------------------------------
                                .BYTE $A9 ; 
                                .BYTE $D0 ; 
                                .BYTE $4C ; L
                                .BYTE $C2 ; 
                                .BYTE $7B ; {

; =============== S U B R O U T I N E =======================================


from_exploding_ship:
                                LDA     byte_5
                                CMP     #$80 ; ''
                                BCC     loc_7C60
                                EOR     #$FF
                                STA     byte_5
                                LDA     byte_4
                                EOR     #$FF
                                ADC     #0
                                STA     byte_4
                                BCC     loc_7C5F
                                INC     byte_5

loc_7C5F:
                                SEC

loc_7C60:
                                ROL     byte_8
                                LDA     byte_7
                                CMP     #$80 ; ''
                                BCC     loc_7C79
                                EOR     #$FF
                                STA     byte_7
                                LDA     byte_6
                                EOR     #$FF
                                ADC     #0
                                STA     byte_6
                                BCC     loc_7C78
                                INC     byte_7

loc_7C78:
                                SEC

loc_7C79:
                                ROL     byte_8
                                LDA     byte_5
                                ORA     byte_7
                                BEQ     loc_7C8B
                                LDX     #0
                                CMP     #2
                                BCS     loc_7CAB
                                LDY     #1
                                BNE     loc_7C9B

loc_7C8B:
                                LDY     #2
                                LDX     #9
                                LDA     byte_4
                                ORA     byte_6
                                BEQ     loc_7CAB
                                BMI     loc_7C9B

loc_7C97:
                                INY
                                ASL     A
                                BPL     loc_7C97

loc_7C9B:
                                TYA
                                TAX
                                LDA     byte_5

loc_7C9F:
                                ASL     byte_4
                                ROL     A
                                ASL     byte_6
                                ROL     byte_7
                                DEY
                                BNE     loc_7C9F
                                STA     byte_5

loc_7CAB:
                                TXA
                                SEC
                                SBC     #$A
                                EOR     #$FF
                                ASL     A
                                ROR     byte_8
                                ROL     A
                                ROR     byte_8
                                ROL     A
                                ASL     A
                                STA     byte_8
                                LDY     #0
                                LDA     byte_6
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                LDA     byte_8
                                AND     #$F4 ; ''
                                ORA     byte_7
                                INY
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                LDA     byte_4
                                INY
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                LDA     byte_8
                                AND     #2
                                ASL     A
                                ORA     byte_1
                                ORA     byte_5
                                INY
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                JMP     update_dvg_curr_addr
; End of function from_exploding_ship


; =============== S U B R O U T I N E =======================================


set_scale_A_bright_0:
                                LDX     #0                                      ; brightness=0
; End of function set_scale_A_bright_0


; =============== S U B R O U T I N E =======================================


set_scale_A_bright_X:
.ifndef APPLE_IIGS
                                LDY     #1
                                STA     (dvg_curr_addr_lsb),Y                   ; store (SSSS -mYY)=A in avg ram
                                DEY
                                TYA
                                STA     (dvg_curr_addr_lsb),Y                   ; store (YYYY YYYY)=0 in avg ram
                                INY
                                INY
                                STA     (dvg_curr_addr_lsb),Y                   ; store (XXXX XXXX)=0 in avg ram
                                INY
                                TXA
                                STA     (dvg_curr_addr_lsb),Y                   ; store (BBBB -mXX)=X in avg ram
                                JMP     update_dvg_curr_addr
.else
                                rts
.endif                                
; End of function set_scale_A_bright_X

; ---------------------------------------------------------------------------

RESET:                                                                          ; Set stack to...
                                LDX     #$FE ; ''
                                TXS                                             ; ...1FE (leave 1FF as an underflow indicator)
                                CLD                                             ; Clear decimal mode
                                LDA     #0                                      ; Clearing RAM
                                TAX                                             ; Offset to X

loc_7CFA:                                                                       ; Count down from 256
                                DEX
                                STA     $300,X                                  ; Clear bank 2 (0300-03FF)
                                STA     $200,X                                  ; Clear bank 1 (0200-02FF)
                                STA     $100,X                                  ; Clear RAM (0100-01FF)
                                STA     0,X                                     ; Clear RAM (0000-00FF)
                                BNE     loc_7CFA                                ; Do all 256 in each area
                                LDY     selfTest                                ; Read IN1
                                BMI     ServiceMode                             ; Upper bit set... go handle service mode
                                INX                                             ; X=1
                                STX     DVGRAM
                                LDA     #$E2 ; ''                              ; JMP $0402
                                STA     DVGRAM+1
.ifndef APPLE_IIGS
                                LDA     #$B0 ; ''                              ; HALT
.else
				                        lda			#OP_HALT
.endif
                                STA     DVGRAM+3
                                STA     placeP1HighScore
                                STA     placeP2HighScore
                                LDA     #3
                                STA     io3200ShadowRegister
                                STA     $3200                                   ; Turn on player 1 & 2 start lamps
                                AND     coinage                                 ; coinage only
                                STA     coinMultCredits
                                LDA     rightCoinMultiplier
                                AND     #3                                      ; multiplier bits only
                                ASL     A
                                ASL     A                                       ; -> bits 3..2
                                ORA     coinMultCredits
                                STA     coinMultCredits
                                LDA     centerCoinMultiplierAndLives
                                AND     #2                                      ; multiplier bit only
                                ASL     A
                                ASL     A
                                ASL     A                                       ; -> bit 4
                                ORA     coinMultCredits
                                STA     coinMultCredits
                                JMP     START

; =============== S U B R O U T I N E =======================================


write_AX_to_avgram:
                                LDY     #0
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                INY
                                TXA
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                JMP     update_dvg_curr_addr
; End of function write_AX_to_avgram

; ---------------------------------------------------------------------------

ServiceMode:                                                                    ; Clear...
                                STA     $4000,X
                                STA     $4100,X                                 ; ... all...
                                STA     $4200,X                                 ; ... of...
                                STA     $4300,X                                 ; ...
                                STA     $4400,X                                 ; ...
                                STA     $4500,X                                 ; ...
                                STA     $4600,X                                 ; ...
                                STA     $4700,X                                 ; ...
                                INX                                             ; ...
                                BNE     ServiceMode                             ; ... vector RAM
                                STA     $3400                                   ; Kick watchdog
                                LDX     #0

loc_7D70:
                                LDA     0,X
                                BNE     loc_7DBB
                                LDA     #$11

loc_7D76:
                                STA     0,X
                                TAY
                                EOR     0,X
                                BNE     loc_7DBB
                                TYA
                                ASL     A
                                BCC     loc_7D76
                                INX
                                BNE     loc_7D70
                                STA     $3400                                   ; Kick watchdog
                                TXA
                                STA     globalScale
                                ROL     A

loc_7D8B:
                                STA     byte_1
                                LDY     #0

loc_7D8F:
                                LDX     #$11
                                LDA     (0),Y
                                BNE     loc_7DBF

loc_7D95:
                                TXA
                                STA     (0),Y
                                EOR     (0),Y
                                BNE     loc_7DBF
                                TXA
                                ASL     A
                                TAX
                                BCC     loc_7D95
                                INY
                                BNE     loc_7D8F
                                STA     $3400                                   ; Kick watchdog
                                INC     byte_1
                                LDX     byte_1
                                CPX     #4
                                BCC     loc_7D8F
                                LDA     #$40 ; '@'
                                CPX     #$40 ; '@'
                                BCC     loc_7D8B
                                CPX     #$48 ; 'H'
                                BCC     loc_7D8F
                                BCS     loc_7E24

loc_7DBB:
                                LDY     #0
                                BEQ     loc_7DCD

loc_7DBF:
                                LDY     #0
                                LDX     byte_1
                                CPX     #4
                                BCC     loc_7DCD
                                INY
                                CPX     #$44 ; 'D'
                                BCC     loc_7DCD
                                INY

loc_7DCD:
                                CMP     #$10
                                ROL     A
                                AND     #$1F
                                CMP     #2
                                ROL     A
                                AND     #3

loc_7DD7:
                                DEY
                                BMI     loc_7DDE
                                ASL     A
                                ASL     A
                                BCC     loc_7DD7

loc_7DDE:
                                LSR     A
                                LDX     #$14
                                BCC     loc_7DE5
                                LDX     #$1D

loc_7DE5:                                                                       ; sound (thump) on
                                STX     $3A00
                                LDX     #0                                      ; inner loop = 256
                                LDY     #8                                      ; outer loop = 8

thump_on_loop:
                                BIT     freq3kHz
                                BPL     thump_on_loop

loc_7DF1:
                                BIT     freq3kHz
                                BMI     loc_7DF1
                                DEX
                                STA     $3400                                   ; Kick watchdog
                                BNE     thump_on_loop
                                DEY
                                BNE     thump_on_loop
                                STX     $3A00                                   ; sound (thump) off
                                LDY     #8

thump_off_loop:
                                BIT     freq3kHz
                                BPL     thump_off_loop

loc_7E09:
                                BIT     freq3kHz
                                BMI     loc_7E09
                                DEX
                                STA     $3400                                   ; Kick watchdog
                                BNE     thump_off_loop
                                DEY
                                BNE     thump_off_loop
                                TAX
                                BNE     loc_7DDE

loc_7E1A:                                                                       ; Kick watchdog
                                STA     $3400
                                LDA     selfTest
                                BMI     loc_7E1A                                ; wait for switch to be released

loc_7E22:
                                BPL     loc_7E22

loc_7E24:
                                LDA     #0
                                TAY
                                TAX
                                STA     byte_8
                                LDA     #$50 ; 'P'

loc_7E2C:
                                STA     byte_9
                                LDA     #4
                                STA     byte_B
                                LDA     #$FF

loc_7E34:
                                EOR     (8),Y
                                INY
                                BNE     loc_7E34
                                INC     byte_9
                                DEC     byte_B
                                BNE     loc_7E34
                                STA     $D,X
                                INX
                                STA     $3400                                   ; Kick watchdog
                                LDA     byte_9
                                CMP     #$58 ; 'X'
                                BCC     loc_7E2C
                                BNE     loc_7E4F
                                LDA     #$68 ; 'h'

loc_7E4F:
                                CMP     #$80 ; ''
                                BCC     loc_7E2C
                                STA     P2RAM
                                LDX     #4                                      ; RAMSEL
                                STX     $3200                                   ; output
                                STX     byte_15
                                LDX     #0
                                CMP     P1RAM
                                BEQ     loc_7E65
                                INX

loc_7E65:
                                LDA     P2RAM
                                CMP     #$88 ; ''
                                BEQ     loc_7E6D
                                INX

loc_7E6D:
                                STX     byte_16
                                LDA     #$10
                                STA     globalScale

loc_7E73:
                                LDX     #$24 ; '$'

loc_7E75:
                                LDA     freq3kHz
                                BPL     loc_7E75

loc_7E7A:
                                LDA     freq3kHz
                                BMI     loc_7E7A
                                DEX
                                BPL     loc_7E75

loc_7E82:
                                BIT     halt
                                BMI     loc_7E82
                                STA     $3400                                   ; Kick watchdog
                                LDA     #0
                                STA     dvg_curr_addr_lsb
                                LDA     #$40 ; '@'
                                STA     dvg_curr_addr_msb
                                LDA     diagStep
                                BPL     loc_7EF2
                                LDX     byte_15
                                LDA     hyperspaceSwitch
                                BPL     loc_7EA8
                                EOR     a:byte_9                                        ; *** CA65 use a:
                                BPL     loc_7EA8
                                DEX
                                BEQ     loc_7EA8
                                STX     byte_15

loc_7EA8:
                                LDY     loc_7EB9+2,X
                                LDA     #$B0 ; ''                              ; halt
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                DEY
                                DEY

loc_7EB1:
                                LDA     byte_7EC0,Y
                                STA     (dvg_curr_addr_lsb),Y                   ; store in avg ram
                                DEY
                                BPL     loc_7EB1

loc_7EB9:
                                JMP     loc_7F9D
; ---------------------------------------------------------------------------
                                .BYTE $33, $1D, $17, $D
; entry 1
byte_7EC0:                      .BYTE $80, $A0, 0, 0                            ; CUR
                                .BYTE 0, $70, 0, 0                              ; VEC scale=07
                                .BYTE $FF, $92, $FF, $73                        ; VEC scale=09
; entry 2
                                .BYTE $D0, $A1, $30, 2                          ; CUR
                                .BYTE 0, $70, 0, 0                              ; VEC scale=07
                                .BYTE $7F, $FB                                  ; SVEC
; entry 3
                                .BYTE $D, $E0                                   ; JMP
                                .BYTE 0, $B0                                    ; HALT
                                .BYTE $7E, $FA                                  ; SVEC
; entry 4
                                .BYTE $11, $C0                                  ; JSR
                                .BYTE $78, $FE                                  ; SVEC
                                .BYTE 0, $B0                                    ; HALT
                                .BYTE $13, $C0                                  ; JSR
                                .BYTE 0, $D0                                    ; RTS
                                .BYTE $15, $C0                                  ; JSR
                                .BYTE 0, $D0                                    ; RTS
                                .BYTE $17, $C0                                  ; JSR
                                .BYTE 0, $D0                                    ; RTS
                                .BYTE $7A, $F8                                  ; SVEC
                                .BYTE 0, $D0                                    ; RTS
; ---------------------------------------------------------------------------

loc_7EF2:
                                LDA     #$50 ; 'P'
                                LDX     #0                                      ; addr = 0x5000
                                JSR     write_JSR_cmd                           ; draw test pattern
                                LDA     #105                                    ; X
                                LDX     #147                                    ; Y
                                JSR     write_CURx4_cmd
                                LDA     #$30 ; '0'
                                JSR     set_scale_A_bright_0
                                LDX     #3                                      ; 4 dipswitches to read

read_dsw1:                                                                      ; read next dipswitch
                                LDA     $2800,X
                                AND     #1                                      ; bit0 only
                                STX     byte_B
                                JSR     display_digit_A
                                LDX     byte_B
                                LDA     $2800,X                                 ; read dipswitch again
                                AND     #2                                      ; bit1 only
                                LSR     A                                       ; ->bit0
                                JSR     display_digit_A
                                LDX     byte_B
                                DEX                                             ; done all dipswitches?
                                BPL     read_dsw1                               ; no, loop
                                LDA     #$7A ; 'z'
                                LDX     #$9D ; ''
                                JSR     write_CURx4_cmd
                                LDA     #$10
                                JSR     set_scale_A_bright_0
                                LDA     centerCoinMultiplierAndLives
                                AND     #2                                      ; Coin Multiplier
                                LSR     A
                                ADC     #1
                                JSR     display_digit_A
                                LDA     rightCoinMultiplier
                                AND     #3                                      ; mask off invalid bits
                                TAX
                                LDA     rightCoinMultiplierTable,X
                                JSR     display_digit_A
                                LDA     byte_16
                                BEQ     loc_7F4F
                                LDX     #$88 ; ''
                                LDA     #$50 ; 'P'                              ; addr = 0x5088
                                JSR     write_JSR_cmd                           ; more test pattern?

loc_7F4F:
                                LDX     #$96 ; ''
                                STX     a:byte_C                                        ; *** CA65 use a:
                                LDX     #7

loc_7F56:
                                LDA     $D,X
                                BEQ     loc_7F91
                                PHA
                                STX     a:byte_B                                        ; *** CA65 use a:
                                LDX     a:byte_C                                        ; *** CA65 use a:
                                TXA
                                SEC
                                SBC     #8
                                STA     a:byte_C                                        ; *** CA65 use a:
                                LDA     #$20 ; ' '
                                JSR     write_CURx4_cmd
                                LDA     #$70 ; 'p'
                                JSR     set_scale_A_bright_0
                                LDA     a:byte_B                                        ; *** CA65 use a:
                                JSR     display_digit_A
                                LDA     DVGROM+$6D4
                                LDX     DVGROM+$6D5
                                JSR     write_AX_to_avgram
                                PLA
                                PHA
                                LSR     A
                                LSR     A
                                LSR     A
                                LSR     A
                                JSR     display_digit_A
                                PLA
                                JSR     display_digit_A
                                LDX     a:byte_B                                        ; *** CA65 use a:

loc_7F91:
                                DEX
                                BPL     loc_7F56
                                LDA     #$7F ; ''
                                TAX
                                JSR     write_CURx4_cmd
                                JSR     halt_dvg

loc_7F9D:
                                LDA     #0
                                LDX     #4                                      ; 5 switches to read

read_in0:                                                                       ; read next switch
                                ROL     hyperspaceSwitch,X
                                ROR     A                                       ; shift into bit7
                                DEX                                             ; done all switches?
                                BPL     read_in0                                ; no, loop
                                TAY
                                LDX     #7                                      ; 8 switches to read

read_in1:                                                                       ; read next switch
                                ROL     leftCoinSwitch,X
                                ROL     A                                       ; shift into bit7
                                DEX                                             ; done all switches?
                                BPL     read_in1                                ; no, loop
                                TAX
                                EOR     byte_8
                                STX     byte_8
                                PHP
                                LDA     #4                                      ; RAMSEL
                                STA     $3200                                   ; output
                                ROL     hyperspaceSwitch
                                ROL     A
                                ROL     FireSwitch
                                ROL     A
                                ROL     rotateLeftSwitch
                                ROL     A
                                ROL     rotateRightSwitch
                                ROL     A
                                ROL     thrustSwitch
                                ROL     A
                                TAX
                                PLP
                                BNE     loc_7FDE
                                EOR     byte_A
                                BNE     loc_7FDE
                                TYA
                                EOR     byte_9
                                BEQ     loc_7FE0

loc_7FDE:
                                LDA     #$80 ; ''

loc_7FE0:                                                                       ; sound (bonus life)
                                STA     $3C05
                                STA     $3200                                   ; output
                                STA     $3000                                   ; AVG/DVG go
                                STX     byte_A
                                STY     byte_9
                                LDA     selfTest

loc_7FF0:                                                                       ; infinite loop
                                BPL     loc_7FF0
                                JMP     loc_7E73
; ---------------------------------------------------------------------------
rightCoinMultiplierTable:       .BYTE 1, 4, 5, 6
                                .BYTE $4E ; N
                                .WORD NMI                                       ; NMI vector
                                .WORD RESET                                     ; RESET vector
                                .WORD RESET                                     ; IRQ/BRK vector (unused)
; end of 'ROM'


                                .END
